<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± | Ù…Ù† Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</title>

<!-- Ø³Ù†Ø­Ù…Ù‘Ù„ Upscaler + Ù†Ù…ÙˆØ°Ø¬ ESRGAN x4plus Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ù…Ø¹ fallback Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„ -->

<!-- Ø£Ø¯ÙˆØ§Øª ZIP & Save -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root { --brand:#00e0a4; --bg:#0f1115; --panel:#151923; --text:#e9eef3; }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial}
  header{padding:20px;text-align:center;border-bottom:1px solid #222}
  h1{margin:0 0 8px 0;color:var(--brand);font-weight:700}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #222;border-radius:14px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-size:14px;opacity:.9}
  input[type="file"]{display:block;width:100%;padding:22px;border:2px dashed var(--brand);border-radius:12px;background:#0c0f14;color:#9fb0c3;text-align:center;cursor:pointer}
  input[type="file"]::before{content:"ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±";display:block;font-size:16px;font-weight:bold;color:var(--brand);margin-bottom:6px}
  input[type="number"],input[type="range"],select{background:#0c0f14;color:var(--text);border:1px solid #2a2f3a;border-radius:10px;padding:8px}
  input[type="range"]{width:180px}
  .btn{background:var(--brand);color:#02130e;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .muted{opacity:.8;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .thumb{background:#0c0f14;border:1px solid #2a2f3a;border-radius:12px;overflow:hidden;padding-bottom:10px;position:relative}
  .thumb canvas{width:100%;display:block;opacity:1}
  .fade-in{opacity:0;transition:opacity .5s ease}
  .controls{padding:10px;background:#11171e;border-top:1px solid #2a2f3a;text-align:center}
  .controls label{font-size:12px;display:block;margin-bottom:4px}

  /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
  progress{width:100%;height:14px;border-radius:10px;overflow:hidden;appearance:none;background:#222}
  progress::-webkit-progress-bar{background-color:#222;border-radius:10px}
  progress::-webkit-progress-value{
    background:linear-gradient(270deg,var(--brand),#00b8ff,var(--brand));
    background-size:200% 100%;border-radius:10px;animation:moveBar 2s linear infinite}
  progress::-moz-progress-bar{
    background:linear-gradient(270deg,var(--brand),#00b8ff,var(--brand));
    background-size:200% 100%;border-radius:10px;animation:moveBar 2s linear infinite}
  @keyframes moveBar{0%{background-position:0% 0}100%{background-position:-200% 0}}

  /* Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø±ÙŠØ· */
  #aiStatus{text-align:center;margin-top:10px;font-size:15px;color:#00b8ff;font-weight:bold;min-height:1.4em}
  #aiStatus .spin{display:inline-block;animation:spin 1.2s linear infinite}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  footer{opacity:.85;text-align:center;padding:24px 0;font-size:15px;color:#b4c7d4}
  footer a{color:var(--brand);text-decoration:none;font-weight:bold}

  /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø³Ù… */
  #popup{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999;visibility:hidden;opacity:0;transition:.3s}
  #popup.active{visibility:visible;opacity:1}
  #popup .box{background:#151923;padding:30px;border-radius:16px;text-align:center;max-width:420px;line-height:1.7;box-shadow:0 0 20px rgba(0,0,0,.4)}
  #popup h2{color:var(--brand);margin-bottom:10px}
  #popup button{margin-top:15px}
  #activeUsers{margin-top:10px;font-size:18px;color:#00e0a4;font-weight:bold}

  /* Ø²Ø± Ø§Ù„ØµÙˆØª */
  #soundToggle{position:fixed;bottom:20px;left:20px;background:var(--brand);color:#02130e;border:none;border-radius:50%;width:48px;height:48px;font-size:22px;font-weight:bold;cursor:pointer;box-shadow:0 0 12px rgba(0,0,0,.5);z-index:999;transition:transform .2s ease}
  #soundToggle:hover{transform:scale(1.1)}

  /* Ø³Ø·Ø± Ø§Ù„Ø®ØµÙˆØµÙŠØ© */
  #privacyNote{margin-top:8px;color:#00e0a4;font-weight:700}
</style>
</head>
<body>
<header>
  <h1>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± | Ù…Ù† Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</h1>
  <div class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø¯ 50 ØµÙˆØ±Ø© Ù…Ø¹Ø§Ù‹ | Ù…Ù† Ø£Ø¬Ù„ Ø¹ÙŠÙˆÙ†ÙŠ Ù…ØªØ§Ø¨Ø¹ÙŠÙ†ÙŠ â¤ï¸</div>
  <div id="activeUsers">ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ø¢Ù†: <span id="userCount">0</span> Ù…Ø³ØªØ®Ø¯Ù…</div>
</header>

<main>
  <div class="card">
    <input id="picker" type="file" accept="image/*" multiple title="Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±" />
    <div id="privacyNote">ğŸ”’ Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙˆØ± â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ØªÙØ¹Ø§Ù„Ø¬ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØªÙØ­Ø°Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Øµ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ:</label><br>
        <select id="vertSide">
          <option value="right">ÙŠÙ…ÙŠÙ†</option>
          <option value="left">ÙŠØ³Ø§Ø±</option>
        </select>
      </div>
      <div>
        <label>Ø¹Ø±Ø¶ Ø§Ù„Ù‚Øµ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ: <span id="vertVal">2</span>%</label><br>
        <div class="row">
          <input id="vertCut" type="range" min="0" max="15" step="0.5" value="2">
          <input id="vertNum" type="number" min="0" max="15" step="0.5" value="2" style="width:70px">
        </div>
      </div>
      <div>
        <label>Ù‚Øµ Ø³ÙÙ„ÙŠ: <span id="bottomVal">0</span>%</label><br>
        <div class="row">
          <input id="bottomCut" type="range" min="0" max="20" step="0.5" value="0">
          <input id="bottomNum" type="number" min="0" max="20" step="0.5" value="0" style="width:70px">
        </div>
      </div>
      <div>
        <label>ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†:</label><br>
        <select id="target">
          <option value="same" selected>ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</option>
          <option value="none">Ø¨Ø¯ÙˆÙ† ØªØ±Ù‚ÙŠØ© (Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø©)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card row">
    <button class="btn" id="btnProcess">ğŸ”„ ØªÙ†ÙÙŠØ° Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†)</button>
    <button class="btn" id="btnDownload">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒÙ„ (ØµÙˆØ± Ù…Ù†ÙØµÙ„Ø©)</button>
    <button class="btn" id="btnZip">ğŸ“¦ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ· (ZIP)</button>
    <div class="muted">Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ù†ÙŠØ©.</div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;gap:8px">
      <strong>Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…:</strong>
      <progress id="bar" max="100" value="0"></progress>
      <span id="status" class="muted">Ø¬Ø§Ù‡Ø²</span>
    </div>
    <div id="aiStatus"></div>
  </div>

  <div class="card">
    <h3>ğŸ“¸ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†)</h3>
    <div id="preview" class="grid"></div>
  </div>
</main>

<footer>
  Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù…Ù† Ø¨Ø±Ù…Ø¬Ø© ÙˆÙ…Ù„Ùƒ <strong>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</strong> â€“ ØªØ§Ø¨Ø¹ÙˆÙ‡ Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ:
  <br>ğŸ‘‰ <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">facebook.com/en.mohamed.nasr</a>
</footer>

<!-- ğŸ”Š Ø§Ù„ØµÙˆØª Ø§Ù„Ø®Ù„ÙÙŠ -->
<audio id="bgMusic" src="https://mohamednasr5.github.io/logo/bg.mp3" loop autoplay></audio>
<button id="soundToggle">ğŸ”Š</button>

<!-- âš ï¸ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø³Ù… -->
<div id="popup">
  <div class="box">
    <h2>âš ï¸ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
    <p style="font-size:18px;line-height:1.8;text-align:center;color:#fff;">
      Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©ØŒ <strong>Ø£ÙÙ‚Ù’Ø³ÙÙ… Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ…</strong><br>
      Ø£Ù† Ø£ØªØ§Ø¨Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ <strong>Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</strong> Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ
      (<a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" style="color:#00e0a4;">ØªØ§Ø¨Ø¹ Ù…Ù† Ù‡Ù†Ø§</a>)<br>
      ÙˆØ£Ø´Ù‡Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ù†ÙŠ Ø¥Ù† Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ø£Ø¯Ø§Ø© Ø¯ÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø£Ùˆ Ø£Ù„ØºÙŠØª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§ØŒ
      ÙØ¥Ù†ÙŠ Ø£ÙƒÙˆÙ† Ù‚Ø¯ Ø£Ø®Ù„ÙØª ÙˆØ¹Ø¯ÙŠ ÙˆØ®Ù†Øª Ø£Ù…Ø§Ù†ØªÙŠ ÙˆØ¸Ù„Ù…Øª Ù†ÙØ³ÙŠ.
    </p>
    <p>âœ³ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: <br>
      <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" style="color:#00e0a4;font-weight:bold">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯ Ø§Ù„Ø¢Ù†</a>
    </p>
    <label><input type="checkbox" id="agreeBox"> âœ” Ø£Ù‚Ø± ÙˆØ£Ù‚Ø³Ù… Ø¨Ø°Ù„Ùƒ</label><br>
    <button class="btn" id="agreeBtn" disabled>Ø£Ù‚Ø³Ù… ÙˆØ£Ù‚Ø± Ø¨Ø°Ù„Ùƒ âœ…</button>
  </div>
</div>

<script>
(() => {
  // ===== ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø© =====
  const userCountEl = document.getElementById('userCount');
  let users = Math.floor(Math.random()*(6254-1052+1))+1052;
  userCountEl.textContent = users.toLocaleString('ar-EG');
  setInterval(()=>{ const change=Math.floor(Math.random()*10)-5; users=Math.max(1052,Math.min(6254,users+change)); userCountEl.textContent=users.toLocaleString('ar-EG'); },3000);

  const bgMusic=document.getElementById('bgMusic');
  const soundBtn=document.getElementById('soundToggle');
  let isMuted=false; bgMusic.volume=0.3;
  document.addEventListener('click',()=>{ if(bgMusic.paused && !isMuted) bgMusic.play().catch(()=>{}); },{once:true});
  soundBtn.addEventListener('click',()=>{ if(isMuted){bgMusic.muted=false;bgMusic.play();soundBtn.textContent="ğŸ”Š";}else{bgMusic.muted=true;soundBtn.textContent="ğŸ”‡";} isMuted=!isMuted;});

  // ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… =====
  const picker = document.getElementById('picker');
  const vertCut = document.getElementById('vertCut'), bottomCut = document.getElementById('bottomCut');
  const vertNum = document.getElementById('vertNum'), bottomNum = document.getElementById('bottomNum');
  const vertVal = document.getElementById('vertVal'), bottomVal = document.getElementById('bottomVal');
  const vertSide = document.getElementById('vertSide'), targetSel = document.getElementById('target');
  const previewEl = document.getElementById('preview'), bar = document.getElementById('bar');
  const status = document.getElementById('status'), aiStatus = document.getElementById('aiStatus');
  const btnProcess = document.getElementById('btnProcess'), btnDownload = document.getElementById('btnDownload'), btnZip = document.getElementById('btnZip');

  let files = [];
  // Ø­Ø§Ù„Ø© Ù„ÙƒÙ„ ØµÙˆØ±Ø©
  const items = []; // [{file, img, enhanced, wrap, cv, vcut, bcut, processing:false}]

  // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø¨Ù†Ø¸Ø§Ù… fallback =====
  function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
  async function ensureUpscalerRuntime(){
    if (window.Upscaler) return;
    await loadScript('https://cdn.jsdelivr.net/npm/upscaler/dist/browser/umd/upscaler.min.js');
  }
  async function ensureModelX4Plus(){
    if (window.esrganx4plus) return true;
    try{
      await loadScript('https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-x4plus/dist/umd/index.min.js'); // latest
      if (window.esrganx4plus) return true;
      throw new Error('latest did not expose model');
    }catch(e){
      console.warn('Model latest failed, trying 1.0.0', e);
      try{
        await loadScript('https://cdn.jsdelivr.net/npm/@upscalerjs/esrgan-x4plus@1.0.0/dist/umd/index.min.js');
        return !!window.esrganx4plus;
      }catch(e2){
        console.warn('Model 1.0.0 failed', e2);
        return false;
      }
    }
  }

  let upscaler = null;
  async function ensureAI(){
    if (upscaler) return true;
    aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> ØªÙ‡ÙŠØ¦Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ (x4plus)...';
    try{
      await ensureUpscalerRuntime();
      const modelOK = await ensureModelX4Plus();
      if (!modelOK) {
        aiStatus.textContent = 'âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ­Ø³ÙŠÙ† Ø§Ø­ØªÙŠØ§Ø·ÙŠ.';
        return false;
      }
      upscaler = new window.Upscaler({ model: window.esrganx4plus });
      aiStatus.textContent = 'âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ';
      return true;
    }catch(err){
      console.error(err);
      aiStatus.textContent = 'âš ï¸ ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ­Ø³ÙŠÙ† Ø§Ø­ØªÙŠØ§Ø·ÙŠ.';
      return false;
    }
  }

  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
  function syncRangeNum(range,num,label){
    const setBoth=val=>{ val=clamp(val,parseFloat(range.min),parseFloat(range.max)); range.value=num.value=val; label.textContent=val; };
    range.addEventListener('input',()=>setBoth(parseFloat(range.value)));
    num.addEventListener('input',()=>setBoth(parseFloat(num.value)));
  }
  syncRangeNum(vertCut,vertNum,vertVal);
  syncRangeNum(bottomCut,bottomNum,bottomVal);

  // Ù‚Øµ Ù„Ù„ØµÙˆØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø®Ù„Ø§Ù Ø§Ù„Ù‚Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
  function cropToCanvas(img, opt){
    const { verticalPercent, bottomPercent, side } = opt;
    const vpx = verticalPercent/100, bpx = bottomPercent/100;
    const sx = side==='left' ? img.width*vpx : 0;
    const sw = img.width*(1 - vpx);
    const sh = img.height*(1 - bpx);
    const c = document.createElement('canvas');
    c.width = Math.max(1, Math.round(sw));
    c.height = Math.max(1, Math.round(sh));
    const ctx = c.getContext('2d');
    ctx.imageSmoothingQuality='high';
    ctx.drawImage(img, sx, 0, sw, sh, 0, 0, c.width, c.height);
    return c;
  }

  // ØªØ­Ø³ÙŠÙ† Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Øµ)
  async function aiEnhanceKeepSameSize(baseCanvas){
    // Ù„Ùˆ AI ØºÙŠØ± Ù…ØªØ§Ø­ Ø³Ù†Ù†ÙØ° fallback bicubic
    const aiReady = await ensureAI();
    if (aiReady && upscaler && targetSel.value === 'same'){
      try{
        const upscaled = await upscaler.upscale(baseCanvas, {
          output: 'canvas',
          patchSize: 128,
          padding: 8,
          progress: (p)=>{ status.textContent = `ğŸ”§ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ: ${(p*100|0)}%`; }
        });
        // Downscale Ù„Ù†ÙØ³ Ø£Ø¨Ø¹Ø§Ø¯ baseCanvas
        const out = document.createElement('canvas');
        out.width = baseCanvas.width; out.height = baseCanvas.height;
        out.getContext('2d').drawImage(upscaled, 0, 0, out.width, out.height);
        return out;
      }catch(err){
        console.warn('AI enhance failed, using fallback', err);
      }
    }
    // fallback: bicubic upscale-downscale Ø®ÙÙŠÙ (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯)
    const tmp = document.createElement('canvas');
    // upscale 2x Ø«Ù… downscale Ù„Ù†ÙØ³ Ø§Ù„Ø­Ø¬Ù… (ÙŠØ²ÙŠØ¯ Ù†Ø¹ÙˆÙ…Ø© Ø¨Ø³ÙŠØ·Ø© Ø¨Ø¯Ù„ Ù„Ø§Ø´ÙŠØ¡)
    tmp.width = baseCanvas.width*2; tmp.height = baseCanvas.height*2;
    tmp.getContext('2d').drawImage(baseCanvas, 0, 0, tmp.width, tmp.height);
    const out = document.createElement('canvas');
    out.width = baseCanvas.width; out.height = baseCanvas.height;
    out.getContext('2d').drawImage(tmp, 0, 0, out.width, out.height);
    return out;
  }

  // Ø±Ø³Ù… Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¹ Fade-in
  function drawPreviewWithFade(canvasEl, srcCanvas){
    canvasEl.classList.add('fade-in');
    // Ø§Ø¶Ø¨Ø· Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ù…ØµØºÙ‘Ø±
    const scale = Math.min(1, 260 / srcCanvas.width);
    const w = Math.max(1, Math.round(srcCanvas.width * scale));
    const h = Math.max(1, Math.round(srcCanvas.height * scale));
    canvasEl.width = w; canvasEl.height = h;
    const ctx = canvasEl.getContext('2d');
    ctx.clearRect(0,0,w,h);
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(srcCanvas, 0, 0, w, h);
    // trigger fade-in
    requestAnimationFrame(()=>{ canvasEl.style.opacity = '1'; canvasEl.classList.remove('fade-in'); });
  }

  function disableActions(flag){
    [btnProcess, btnDownload, btnZip, picker, vertCut, vertNum, bottomCut, bottomNum, vertSide, targetSel]
      .forEach(el => el.disabled = flag);
  }

  function getGlobalOptions(){
    return {
      verticalPercent: parseFloat(vertNum.value),
      bottomPercent: parseFloat(bottomNum.value),
      side: vertSide.value,
      target: targetSel.value
    };
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© (Ù‚Øµ + AI) ÙˆØ¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
  async function processOne(idx, opts){
    const it = items[idx]; if (!it || it.processing) return;
    it.processing = true;
    try{
      const base = cropToCanvas(it.img, opts);
      const enhanced = (opts.target === 'same') ? await aiEnhanceKeepSameSize(base) : base;
      it.enhanced = enhanced;
      drawPreviewWithFade(it.cv, enhanced);
    } finally {
      it.processing = false;
    }
  }

  // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ
  async function processAllParallel(){
    if (!items.length) return;
    aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> Ø¬Ø§Ø±Ù ØªØ­Ø³ÙŠÙ† ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ...';
    disableActions(true); bar.value = 0; status.textContent = 'ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
    let done = 0;
    const opts = getGlobalOptions();
    await Promise.all(items.map((_, i) => (async () => {
      await processOne(i, opts);
      done++; bar.value = (done / items.length) * 100;
      status.textContent = `âš™ï¸ ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© ${done}/${items.length}`;
    })()));
    aiStatus.textContent = 'âœ… ØªÙ… ØªØ­Ø³ÙŠÙ† ÙƒÙ„ Ø§Ù„ØµÙˆØ±';
    disableActions(false);
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„ØµÙˆØ±Ø©
  function createThumb(i){
    const wrap = document.createElement('div'); wrap.className='thumb';
    const cv = document.createElement('canvas'); cv.classList.add('fade-in'); wrap.appendChild(cv);
    const controls = document.createElement('div'); controls.className='controls';
    controls.innerHTML = `
      <label>Ù‚Øµ Ø¹Ù…ÙˆØ¯ÙŠ: <input type="range" min="0" max="15" step="0.5" value="${vertNum.value}" class="vcut"></label>
      <label>Ù‚Øµ Ø³ÙÙ„ÙŠ: <input type="range" min="0" max="20" step="0.5" value="${bottomNum.value}" class="bcut"></label>
      <button class="btn save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>
    `;
    wrap.appendChild(controls);
    // Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø«
    const vcut = controls.querySelector('.vcut');
    const bcut = controls.querySelector('.bcut');
    const saveBtn = controls.querySelector('.save');
    // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
    items[i].wrap = wrap; items[i].cv = cv; items[i].vcut = vcut; items[i].bcut = bcut;

    let localTimer;
    const reprocessLocal = ()=>{
      if (!items[i]) return;
      // Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø· (debounce)
      clearTimeout(localTimer);
      localTimer = setTimeout(()=>processOne(i, {
        verticalPercent: parseFloat(vcut.value),
        bottomPercent: parseFloat(bcut.value),
        side: vertSide.value,
        target: targetSel.value
      }), 150);
    };
    vcut.addEventListener('input', reprocessLocal);
    bcut.addEventListener('input', reprocessLocal);

    saveBtn.addEventListener('click', async ()=>{
      if (!items[i]) return;
      const opts = {
        verticalPercent: parseFloat(vcut.value),
        bottomPercent: parseFloat(bcut.value),
        side: vertSide.value,
        target: targetSel.value
      };
      // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯ Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„ØŒ Ø£Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø«Ù… Ø§Ø­ÙØ¸
      if (!items[i].enhanced || items[i].processing) await processOne(i, opts);
      const canvas = items[i].enhanced;
      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.95));
      saveAs(blob, `mohamed_hammad${i+1}_AI.jpg`);
    });

    return wrap;
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙÙˆØ±ÙŠ ÙÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠ
  picker.addEventListener('change', async ()=>{
    files = Array.from(picker.files);
    previewEl.innerHTML=''; items.length = 0;
    if (!files.length) return;

    // Ø¬Ù‡Ù‘Ø² Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø§Ù„Ø©
    for (let i=0;i<files.length;i++) items.push({ file: files[i], img: null, enhanced: null, processing:false });

    // Ø§ØµÙ†Ø¹ Ø«ÙÙ…ÙØ§Ù†Ø¨ÙŠÙ„Ø² + Ø¥Ø·Ø§Ø±Ø§Øª
    for (let i=0;i<files.length;i++){
      const thumb = createThumb(i);
      previewEl.appendChild(thumb);
    }

    // Ø­Ù…Ù‘Ù„ Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ù‹Ø§
    await Promise.all(items.map(async (it, idx)=>{
      it.img = await new Promise((res,rej)=>{
        const im = new Image();
        im.onload = ()=>res(im);
        im.onerror = rej;
        im.src = URL.createObjectURL(it.file);
      });
    }));

    // Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠ
    await processAllParallel();
  });

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø¬Ù…ÙŠØ¹ (ÙˆÙÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
  btnProcess.addEventListener('click', async ()=>{
    if (!items.length) return alert('Ø§Ø±ÙØ¹ ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹');
    await processAllParallel();
  });

  // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒÙ„ (Ù…Ù„ÙØ§Øª Ù…Ù†ÙØµÙ„Ø©)
  btnDownload.addEventListener('click', async ()=>{
    if (!items.length) return alert('Ø§Ø±ÙØ¹ ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹');
    disableActions(true); aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ± Ù„Ù„ØªÙ†Ø²ÙŠÙ„...';
    // Ù„Ùˆ ÙÙŠ Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…Ø­Ø³Ù‘Ù†Ø© Ù†ØªÙŠØ¬Ø© ØªØºÙŠÙŠØ±Ø§ØªØŒ Ø£Ø¹Ø¯ ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ
    const opts = getGlobalOptions();
    await Promise.all(items.map((it, i)=> (async ()=>{
      if (!it.enhanced || it.processing) await processOne(i, opts);
      const blob = await new Promise(r => it.enhanced.toBlob(r, 'image/jpeg', 0.95));
      saveAs(blob, `mohamed_hammad${i+1}_AI.jpg`);
    })()));
    aiStatus.textContent = 'âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„ØµÙˆØ±';
    disableActions(false);
  });

  // ØªÙ†Ø²ÙŠÙ„ ÙƒÙ…Ù„Ù Ù…Ø¶ØºÙˆØ·
  btnZip.addEventListener('click', async ()=>{
    if (items.length < 2) return alert('Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©');
    disableActions(true); aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·...';
    const zip = new JSZip();
    const opts = getGlobalOptions();
    await Promise.all(items.map((it, i)=> (async ()=>{
      if (!it.enhanced || it.processing) await processOne(i, opts);
      const blob = await new Promise(r => it.enhanced.toBlob(r, 'image/jpeg', 0.95));
      zip.file(`mohamed_hammad${i+1}_AI.jpg`, blob);
    })()));
    const zipBlob = await zip.generateAsync({ type:'blob' });
    saveAs(zipBlob, 'mohamed_hammad_images.zip');
    aiStatus.textContent = 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·';
    disableActions(false);
  });

  // Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø³Ù…
  const popup=document.getElementById('popup');
  const agreeBox=document.getElementById('agreeBox');
  const agreeBtn=document.getElementById('agreeBtn');
  if(!localStorage.getItem('agreedToFollow')) popup.classList.add('active');
  agreeBox.addEventListener('change',()=>agreeBtn.disabled=!agreeBox.checked);
  agreeBtn.addEventListener('click',()=>{ localStorage.setItem('agreedToFollow','true'); popup.classList.remove('active'); });
})();
</script>
</body>
</html>
