<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± | Ù…Ù† Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</title>

<!-- ğŸ“¦ Ù…ÙƒØ§ØªØ¨ Ø®Ø§Ø±Ø¬ÙŠØ©: Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ + ZIP + Ø§Ù„Ø­ÙØ¸ -->
<!-- Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ù‰: Ù†Ù…ÙˆØ°Ø¬ ESRGAN Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ -->
<script src="https://cdn.jsdelivr.net/npm/@upscalerjs/default-model@1.0.0/dist/browser/index.min.js"></script>
<!-- Ø§Ù„Ù…Ø­Ø±Ù‘Ùƒ -->
<script src="https://cdn.jsdelivr.net/npm/upscaler/dist/browser/umd/upscaler.min.js"></script>

<!-- Ø£Ø¯ÙˆØ§Øª ZIP & Save -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root { --brand:#00e0a4; --bg:#0f1115; --panel:#151923; --text:#e9eef3; }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial}
  header{padding:20px;text-align:center;border-bottom:1px solid #222}
  h1{margin:0 0 8px 0;color:var(--brand);font-weight:700}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #222;border-radius:14px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-size:14px;opacity:.9}
  input[type="file"]{display:block;width:100%;padding:22px;border:2px dashed var(--brand);border-radius:12px;background:#0c0f14;color:#9fb0c3;text-align:center;cursor:pointer}
  input[type="file"]::before{content:"ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±";display:block;font-size:16px;font-weight:bold;color:var(--brand);margin-bottom:6px}
  input[type="number"],input[type="range"],select{background:#0c0f14;color:var(--text);border:1px solid #2a2f3a;border-radius:10px;padding:8px}
  input[type="range"]{width:180px}
  .btn{background:var(--brand);color:#02130e;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .muted{opacity:.8;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .thumb{background:#0c0f14;border:1px solid #2a2f3a;border-radius:12px;overflow:hidden;padding-bottom:10px}
  .thumb canvas{width:100%;display:block}
  .controls{padding:10px;background:#11171e;border-top:1px solid #2a2f3a;text-align:center}
  .controls label{font-size:12px;display:block;margin-bottom:4px}

  /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
  progress {
    width: 100%;
    height: 14px;
    border-radius: 10px;
    overflow: hidden;
    appearance: none;
    background: #222;
  }
  progress::-webkit-progress-bar {background-color:#222;border-radius:10px;}
  progress::-webkit-progress-value {
    background: linear-gradient(270deg, var(--brand), #00b8ff, var(--brand));
    background-size: 200% 100%;
    border-radius: 10px;
    animation: moveBar 2s linear infinite;
  }
  progress::-moz-progress-bar {
    background: linear-gradient(270deg, var(--brand), #00b8ff, var(--brand));
    background-size: 200% 100%;
    border-radius: 10px;
    animation: moveBar 2s linear infinite;
  }
  @keyframes moveBar {
    0% { background-position: 0% 0; }
    100% { background-position: -200% 0; }
  }

  /* Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø±ÙŠØ· */
  #aiStatus {
    text-align:center; margin-top:10px; font-size:15px; color:#00b8ff; font-weight:bold; min-height:1.4em;
  }
  #aiStatus .spin { display:inline-block; animation: spin 1.2s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  footer{opacity:.85;text-align:center;padding:24px 0;font-size:15px;color:#b4c7d4}
  footer a{color:var(--brand);text-decoration:none;font-weight:bold}

  /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø³Ù… */
  #popup{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;visibility:hidden;opacity:0;transition:.3s;}
  #popup.active{visibility:visible;opacity:1;}
  #popup .box{background:#151923;padding:30px;border-radius:16px;text-align:center;max-width:420px;line-height:1.7;box-shadow:0 0 20px rgba(0,0,0,0.4);}
  #popup h2{color:var(--brand);margin-bottom:10px}
  #popup button{margin-top:15px}
  #activeUsers{margin-top:10px;font-size:18px;color:#00e0a4;font-weight:bold;}

  /* Ø²Ø± Ø§Ù„ØµÙˆØª */
  #soundToggle { position: fixed;bottom: 20px;left: 20px;background: var(--brand);color: #02130e;border: none;border-radius: 50%;width: 48px;height: 48px;font-size: 22px;font-weight: bold;cursor: pointer;box-shadow: 0 0 12px rgba(0,0,0,0.5);z-index: 999;transition: transform .2s ease; }
  #soundToggle:hover { transform: scale(1.1); }
</style>
</head>
<body>
<header>
  <h1>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± | Ù…Ù† Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</h1>
  <div class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø¯ 50 ØµÙˆØ±Ø© Ù…Ø¹Ø§Ù‹ | Ù…Ù† Ø£Ø¬Ù„ Ø¹ÙŠÙˆÙ†ÙŠ Ù…ØªØ§Ø¨Ø¹ÙŠÙ†ÙŠ â¤ï¸</div>
  <div id="activeUsers">ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ø¢Ù†: <span id="userCount">0</span> Ù…Ø³ØªØ®Ø¯Ù…</div>
</header>

<main>
  <div class="card">
    <input id="picker" type="file" accept="image/*" multiple title="Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±" />
    <div class="row" style="margin-top:12px">
      <div>
        <label>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Øµ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ:</label><br>
        <select id="vertSide">
          <option value="right">ÙŠÙ…ÙŠÙ†</option>
          <option value="left">ÙŠØ³Ø§Ø±</option>
        </select>
      </div>
      <div>
        <label>Ø¹Ø±Ø¶ Ø§Ù„Ù‚Øµ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ: <span id="vertVal">2</span>%</label><br>
        <div class="row">
          <input id="vertCut" type="range" min="0" max="15" step="0.5" value="2">
          <input id="vertNum" type="number" min="0" max="15" step="0.5" value="2" style="width:70px">
        </div>
      </div>
      <div>
        <label>Ù‚Øµ Ø³ÙÙ„ÙŠ: <span id="bottomVal">0</span>%</label><br>
        <div class="row">
          <input id="bottomCut" type="range" min="0" max="20" step="0.5" value="0">
          <input id="bottomNum" type="number" min="0" max="20" step="0.5" value="0" style="width:70px">
        </div>
      </div>
      <div>
        <label>Ø§Ù„Ù‡Ø¯Ù:</label><br>
        <select id="target">
          <option value="4k">4K (3840Ã—2160 - Ù‚Øµ Ù„Ù€Ù€ 16:9)</option>
          <option value="uhd3840">Ø£Ø·ÙˆÙ„ Ø¶Ù„Ø¹ = 3840 (Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨Ø©)</option>
          <option value="none">Ø¨Ø¯ÙˆÙ† ØªØ±Ù‚ÙŠØ© (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card row">
    <button class="btn" id="btnProcess">ğŸ”„ ØªÙ†ÙÙŠØ° Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„</button>
    <button class="btn" id="btnDownload">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒÙ„ (ØµÙˆØ± Ù…Ù†ÙØµÙ„Ø©)</button>
    <button class="btn" id="btnZip">ğŸ“¦ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ· (ZIP)</button>
    <div class="muted">ÙƒÙ„ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙŠØ­Ø¯Ø« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±Ù‹Ø§.</div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;gap:8px">
      <strong>Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…:</strong>
      <progress id="bar" max="100" value="0"></progress>
      <span id="status" class="muted">Ø¬Ø§Ù‡Ø²</span>
    </div>
    <div id="aiStatus"></div>
  </div>

  <div class="card">
    <h3>ğŸ“¸ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª</h3>
    <div id="preview" class="grid"></div>
  </div>
</main>

<footer>
  Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù…Ù† Ø¨Ø±Ù…Ø¬Ø© ÙˆÙ…Ù„Ùƒ <strong>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</strong> â€“ ØªØ§Ø¨Ø¹ÙˆÙ‡ Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ:
  <br>ğŸ‘‰ <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">facebook.com/en.mohamed.nasr</a>
</footer>

<!-- ğŸ”Š Ø§Ù„ØµÙˆØª Ø§Ù„Ø®Ù„ÙÙŠ (Ø§Ø³ØªØ¶Ø§ÙØ© Ù…Ù† GitHub Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ) -->
<audio id="bgMusic" src="https://mohamednasr5.github.io/logo/bg.mp3" loop autoplay></audio>
<button id="soundToggle">ğŸ”Š</button>

<!-- âš ï¸ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø³Ù… -->
<div id="popup">
  <div class="box">
    <h2>âš ï¸ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
    <p style="font-size:18px;line-height:1.8;text-align:center;color:#fff;">
      Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©ØŒ <strong>Ø£ÙÙ‚Ù’Ø³ÙÙ… Ø¨Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ…</strong><br>
      Ø£Ù† Ø£ØªØ§Ø¨Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ <strong>Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</strong> Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ
      (<a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" style="color:#00e0a4;">ØªØ§Ø¨Ø¹ Ù…Ù† Ù‡Ù†Ø§</a>)<br>
      ÙˆØ£Ø´Ù‡Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ù†ÙŠ Ø¥Ù† Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ø£Ø¯Ø§Ø© Ø¯ÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø£Ùˆ Ø£Ù„ØºÙŠØª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§ØŒ
      ÙØ¥Ù†ÙŠ Ø£ÙƒÙˆÙ† Ù‚Ø¯ Ø£Ø®Ù„ÙØª ÙˆØ¹Ø¯ÙŠ ÙˆØ®Ù†Øª Ø£Ù…Ø§Ù†ØªÙŠ ÙˆØ¸Ù„Ù…Øª Ù†ÙØ³ÙŠ.
    </p>
    <p>âœ³ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: <br>
      <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" style="color:#00e0a4;font-weight:bold">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯ Ø§Ù„Ø¢Ù†</a>
    </p>
    <label><input type="checkbox" id="agreeBox"> âœ” Ø£Ù‚Ø± ÙˆØ£Ù‚Ø³Ù… Ø¨Ø°Ù„Ùƒ</label><br>
    <button class="btn" id="agreeBtn" disabled>Ø£Ù‚Ø³Ù… ÙˆØ£Ù‚Ø± Ø¨Ø°Ù„Ùƒ âœ…</button>
  </div>
</div>

<script>
(() => {
  // ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…Ø© =====
  const userCountEl = document.getElementById('userCount');
  let users = Math.floor(Math.random() * (6254 - 1052 + 1)) + 1052;
  userCountEl.textContent = users.toLocaleString('ar-EG');
  setInterval(() => {
    const change = Math.floor(Math.random() * 10) - 5;
    users = Math.max(1052, Math.min(6254, users + change));
    userCountEl.textContent = users.toLocaleString('ar-EG');
  }, 3000);

  const bgMusic = document.getElementById('bgMusic');
  const soundBtn = document.getElementById('soundToggle');
  let isMuted = false; bgMusic.volume = 0.3;
  document.addEventListener('click', () => { if (bgMusic.paused && !isMuted) bgMusic.play().catch(()=>{}); }, { once: true });
  soundBtn.addEventListener('click', () => {
    if (isMuted) { bgMusic.muted = false; bgMusic.play(); soundBtn.textContent = "ğŸ”Š"; }
    else { bgMusic.muted = true; soundBtn.textContent = "ğŸ”‡"; }
    isMuted = !isMuted;
  });

  // ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… =====
  const picker = document.getElementById('picker');
  const vertCut = document.getElementById('vertCut'), bottomCut = document.getElementById('bottomCut');
  const vertNum = document.getElementById('vertNum'), bottomNum = document.getElementById('bottomNum');
  const vertVal = document.getElementById('vertVal'), bottomVal = document.getElementById('bottomVal');
  const vertSide = document.getElementById('vertSide'), targetSel = document.getElementById('target');
  const previewEl = document.getElementById('preview');
  const bar = document.getElementById('bar'), status = document.getElementById('status'), aiStatus = document.getElementById('aiStatus');
  const btnProcess = document.getElementById('btnProcess'), btnDownload = document.getElementById('btnDownload'), btnZip = document.getElementById('btnZip');

  let files = [], previews = [];
  let upscaler = null;         // ÙƒØ§Ø¦Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
  let aiAvailable = false;     // Ù‡Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø§Ù‡Ø²ØŸ

  // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =====
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
  function syncRangeNum(range, num, label){
    const setBoth = val => { val = clamp(val, parseFloat(range.min), parseFloat(range.max));
      range.value = num.value = val; label.textContent = val; updateGlobalPreviewsDebounced(); };
    range.addEventListener('input', () => setBoth(parseFloat(range.value)));
    num.addEventListener('input', () => setBoth(parseFloat(num.value)));
  }
  syncRangeNum(vertCut, vertNum, vertVal);
  syncRangeNum(bottomCut, bottomNum, bottomVal);
  [vertSide, targetSel].forEach(el => el.addEventListener('change', updateGlobalPreviewsDebounced));

  // Debounce Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
  let previewTimer; 
  function updateGlobalPreviewsDebounced() {
    clearTimeout(previewTimer);
    previewTimer = setTimeout(updateGlobalPreviews, 120);
  }

  // ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø¹Ù†ØµØ± Image
  function loadImage(file){
    return new Promise((res, rej) => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = rej;
      img.src = URL.createObjectURL(file);
    });
  }

  // Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ø§Ù…Ø©
  function getGlobalOptions(){
    return {
      verticalPercent: parseFloat(vertNum.value),
      bottomPercent: parseFloat(bottomNum.value),
      side: vertSide.value,
      target: targetSel.value
    };
  }

  // Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ ÙƒØ§Ù†ÙØ§Ø³ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªØ±Ù‚ÙŠØ©)
  function cropToCanvas(img, opt){
    const { verticalPercent, bottomPercent, side } = opt;
    const vpx = verticalPercent / 100, bpx = bottomPercent / 100;
    const sx = side === 'left' ? img.width * vpx : 0;
    const sw = img.width * (1 - vpx), sh = img.height * (1 - bpx);
    const c = document.createElement('canvas');
    c.width = Math.max(1, Math.round(sw));
    c.height = Math.max(1, Math.round(sh));
    const ctx = c.getContext('2d');
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, sx, 0, sw, sh, 0, 0, c.width, c.height);
    return c;
  }

  // Ù‚Øµ Ù„Ù…Ø¹Ø§Ù…Ù„ 16:9 Ø«Ù… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ 3840Ã—2160
  function force4K(canvasIn){
    const W = canvasIn.width, H = canvasIn.height;
    const targetRatio = 16/9, curRatio = W / H;
    let sx = 0, sy = 0, sw = W, sh = H;
    if (curRatio > targetRatio) {
      // Ù‚Øµ Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠÙ†
      sw = H * targetRatio;
      sx = (W - sw) / 2;
    } else if (curRatio < targetRatio) {
      // Ù‚Øµ Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„
      sh = W / targetRatio;
      sy = (H - sh) / 2;
    }
    const crop = document.createElement('canvas');
    crop.width = Math.round(sw); crop.height = Math.round(sh);
    crop.getContext('2d').drawImage(canvasIn, sx, sy, sw, sh, 0, 0, crop.width, crop.height);

    const out = document.createElement('canvas');
    out.width = 3840; out.height = 2160;
    const ctx2 = out.getContext('2d');
    ctx2.imageSmoothingQuality = 'high';
    ctx2.drawImage(crop, 0, 0, out.width, out.height);
    return out;
  }

  // ØªØ­Ø¬ÙŠÙ… Ø¨Ø­ÙŠØ« Ø£Ø·ÙˆÙ„ Ø¶Ù„Ø¹ = 3840 Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø©
  function fitMax3840(canvasIn){
    const W = canvasIn.width, H = canvasIn.height;
    const ratio = 3840 / Math.max(W, H);
    if (ratio <= 1) {
      const out = document.createElement('canvas');
      out.width = Math.round(W * ratio);
      out.height = Math.round(H * ratio);
      out.getContext('2d').drawImage(canvasIn, 0, 0, out.width, out.height);
      return out;
    }
    // Ù„Ùˆ Ø£ØµØºØ± Ù…Ù† 3840 Ø£ØµÙ„Ø§Ù‹ØŒ Ù†ÙƒØªÙÙŠ Ø¨Ø¥Ø±Ø¬Ø§Ø¹Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ (Ø¨Ø¹Ø¯ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ù‡ÙŠÙƒØ¨Ø± ØºØ§Ù„Ø¨Ù‹Ø§)
    return canvasIn;
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  async function ensureUpscaler() {
    if (upscaler || aiAvailable === true) return;
    aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> ØªÙ‡ÙŠØ¦Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ...';
    try {
      if (!window.Upscaler) throw new Error('UpscalerJS not loaded');
      // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Upscaler (Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø­Ù…Ù‘Ù„ Ø¹Ø¨Ø± CDN)
      upscaler = new window.Upscaler({
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… patchSize Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        // ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø¹Ø¨Ø± progress
      });
      aiAvailable = true;
      aiStatus.textContent = 'âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­';
    } catch (e) {
      aiAvailable = false;
      aiStatus.textContent = 'âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ±Ù‚ÙŠØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³Ø±ÙŠØ¹Ø©.';
      console.warn('AI init error:', e);
    }
  }

  // ØªØ±Ù‚ÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØŒ Ù…Ø¹ fallback
  async function upscaleAI(canvasIn){
    await ensureUpscaler();
    if (aiAvailable && upscaler) {
      try {
        aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ...';
        // Ù†Ø³ØªØ®Ø¯Ù… output: 'canvas' Ù„ÙŠØ±Ø¬Ø¹ ÙƒØ§Ù†ÙØ§Ø³ Ø¬Ø§Ù‡Ø²
        const upscaled = await upscaler.upscale(canvasIn, {
          output: 'canvas',
          // ØªÙØªÙŠØª Ø§Ù„ØµÙˆØ±Ø© Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ©
          patchSize: 128,
          padding: 10,
          progress: (p) => {
            // p Ù…Ù† 0 Ø¥Ù„Ù‰ 1 â€” Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ù„Ø·ÙŠÙ
            status.textContent = `ğŸ”§ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ: ${(p*100).toFixed(0)}%`;
          }
        });
        aiStatus.textContent = 'âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!';
        return upscaled;
      } catch (e) {
        console.warn('AI upscale error, falling back:', e);
        aiStatus.textContent = 'âš ï¸ Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ â€” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ±Ù‚ÙŠØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.';
      }
    }
    // Fallback: ØªÙƒØ¨ÙŠØ± bicubic ÙÙ‚Ø· (Ø£Ø³Ø±Ø¹ Ù…Ù† Ù„Ø§ Ø´ÙŠØ¡)
    const fallback = document.createElement('canvas');
    const s = 2; // ØªÙƒØ¨ÙŠØ± 2Ã— ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·
    fallback.width = canvasIn.width * s;
    fallback.height = canvasIn.height * s;
    const ctx = fallback.getContext('2d');
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(canvasIn, 0, 0, fallback.width, fallback.height);
    return fallback;
  }

  // Ø±Ø³Ù… Ù…ØµØºÙ‘Ø± Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  function drawToCanvas(cv, src){
    const ctx = cv.getContext('2d');
    const scale = Math.min(1, 260 / src.width);
    cv.width = Math.max(1, Math.round(src.width * scale));
    cv.height = Math.max(1, Math.round(src.height * scale));
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(src, 0, 0, cv.width, cv.height);
  }

  function createPreview(canvas, name, i){
    const wrap = document.createElement('div'); wrap.className = 'thumb';
    const cv = document.createElement('canvas'); wrap.appendChild(cv);
    drawToCanvas(cv, canvas);

    const controls = document.createElement('div'); controls.className = 'controls';
    controls.innerHTML = `
      <label>Ù‚Øµ Ø¹Ù…ÙˆØ¯ÙŠ: <input type="range" min="0" max="15" step="0.5" value="${vertNum.value}" class="vcut"></label>
      <label>Ù‚Øµ Ø³ÙÙ„ÙŠ: <input type="range" min="0" max="20" step="0.5" value="${bottomNum.value}" class="bcut"></label>
      <button class="btn save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>
    `;
    wrap.appendChild(controls);

    const vcut = controls.querySelector('.vcut');
    const bcut = controls.querySelector('.bcut');
    const saveBtn = controls.querySelector('.save');

    const updateLocal = async () => {
      const img = previews[i]?.img; if (!img) return;
      const base = cropToCanvas(img, {
        verticalPercent: parseFloat(vcut.value),
        bottomPercent: parseFloat(bcut.value),
        side: vertSide.value,
        target: targetSel.value
      });
      // Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… AI Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø© (Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø«Ù‚ÙŠÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸/Ø§Ù„ØªÙ†Ø²ÙŠÙ„)
      drawToCanvas(cv, base);
    };
    vcut.addEventListener('input', updateLocal);
    bcut.addEventListener('input', updateLocal);

    saveBtn.addEventListener('click', async () => {
      disableActions(true);
      try {
        const img = previews[i]?.img; if (!img) return;
        status.textContent = 'ğŸ”§ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø­ÙØ¸...';
        barRemoveIndeterminate(); bar.value = 0;
        const base = cropToCanvas(img, {
          verticalPercent: parseFloat(vcut.value),
          bottomPercent: parseFloat(bcut.value),
          side: vertSide.value,
          target: targetSel.value
        });
        const up = await upscaleAI(base);
        const finalCanvas = (targetSel.value === '4k') ? force4K(up)
                           : (targetSel.value === 'uhd3840') ? fitMax3840(up) : up;
        const blob = await new Promise(r => finalCanvas.toBlob(r, 'image/jpeg', 0.95));
        saveAs(blob, `mohamed_hammad${i+1}_4K.jpg`);
        status.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©';
      } catch (e) {
        console.error(e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.');
      } finally {
        aiStatus.textContent = '';
        disableActions(false);
      }
    });

    return wrap;
  }

  // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª (Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† AI)
  async function updateGlobalPreviews() {
    if (!files.length) return;
    const thumbs = previewEl.querySelectorAll('.thumb');
    for (let i = 0; i < files.length; i++) {
      const wrap = thumbs[i]; if (!wrap) continue;
      const cv = wrap.querySelector('canvas');
      const img = previews[i]?.img || await loadImage(files[i]);
      previews[i] = previews[i] || { img };
      const base = cropToCanvas(img, getGlobalOptions());
      drawToCanvas(cv, base);
    }
  }

  // ØªØ¹Ø·ÙŠÙ„/ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  function disableActions(flag){
    [btnProcess, btnDownload, btnZip, picker].forEach(b => b.disabled = flag);
  }
  function barIndeterminate(){ bar.removeAttribute('value'); }
  function barRemoveIndeterminate(){ if (!bar.hasAttribute('value')) bar.value = 0; }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  picker.addEventListener('change', async () => {
    files = Array.from(picker.files);
    if (!files.length) return;
    previewEl.innerHTML = ''; previews = [];
    for (let i = 0; i < files.length; i++) {
      const img = await loadImage(files[i]);
      const base = cropToCanvas(img, getGlobalOptions());
      const div = createPreview(base, files[i].name, i);
      previewEl.appendChild(div);
      previews.push({ img, base, div });
    }
    status.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${files.length} ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©`;
    aiStatus.textContent = '';
  });

  document.getElementById('btnProcess').addEventListener('click', async () => {
    if (!files.length) return alert('Ø§Ø±ÙØ¹ ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹');
    status.textContent = 'ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª...';
    await updateGlobalPreviews();
    status.textContent = 'âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ (Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·)';
  });

  document.getElementById('btnDownload').addEventListener('click', async () => {
    if (!files.length) return alert('Ø§Ø±ÙØ¹ ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹');
    disableActions(true);
    aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ...';
    barRemoveIndeterminate(); bar.value = 0; status.textContent = 'ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
    try {
      await ensureUpscaler();
      for (let i = 0; i < files.length; i++) {
        const img = previews[i]?.img || await loadImage(files[i]);
        const base = cropToCanvas(img, getGlobalOptions());
        const up = await upscaleAI(base);
        const finalCanvas = (targetSel.value === '4k') ? force4K(up)
                           : (targetSel.value === 'uhd3840') ? fitMax3840(up) : up;
        const blob = await new Promise(r => finalCanvas.toBlob(r, 'image/jpeg', 0.95));
        saveAs(blob, `mohamed_hammad${i+1}_4K.jpg`);
        bar.value = ((i + 1) / files.length) * 100;
        status.textContent = `ğŸ“¥ ØªÙ… ØªÙ†Ø²ÙŠÙ„ ${i + 1}/${files.length}`;
      }
      aiStatus.textContent = 'âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±';
    } catch (e) {
      console.error(e);
      aiStatus.textContent = 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.';
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±.');
    } finally {
      disableActions(false);
    }
  });

  document.getElementById('btnZip').addEventListener('click', async () => {
    if (files.length < 2) return alert('Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©');
    disableActions(true);
    aiStatus.innerHTML = '<span class="spin">ğŸ”„</span> Ø¬Ø§Ø±Ù Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ¶ØºØ· Ø§Ù„ØµÙˆØ±...';
    barRemoveIndeterminate(); bar.value = 0; status.textContent = 'ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
    try {
      await ensureUpscaler();
      const zip = new JSZip();
      for (let i = 0; i < files.length; i++) {
        const img = previews[i]?.img || await loadImage(files[i]);
        const base = cropToCanvas(img, getGlobalOptions());
        const up = await upscaleAI(base);
        const finalCanvas = (targetSel.value === '4k') ? force4K(up)
                           : (targetSel.value === 'uhd3840') ? fitMax3840(up) : up;
        const blob = await new Promise(r => finalCanvas.toBlob(r, 'image/jpeg', 0.95));
        zip.file(`mohamed_hammad${i+1}_4K.jpg`, blob);
        bar.value = ((i + 1) / files.length) * 100;
        status.textContent = `ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ${i + 1}/${files.length} Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·...`;
      }
      const zipBlob = await zip.generateAsync({ type: 'blob' });
      saveAs(zipBlob, 'mohamed_hammad_images.zip');
      aiStatus.textContent = 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·';
    } catch (e) {
      console.error(e);
      aiStatus.textContent = 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¶ØºØ·.';
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·.');
    } finally {
      disableActions(false);
    }
  });

  // Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø³Ù…
  const popup = document.getElementById('popup');
  const agreeBox = document.getElementById('agreeBox');
  const agreeBtn = document.getElementById('agreeBtn');
  if (!localStorage.getItem('agreedToFollow')) popup.classList.add('active');
  agreeBox.addEventListener('change', () => agreeBtn.disabled = !agreeBox.checked);
  agreeBtn.addEventListener('click', () => { localStorage.setItem('agreedToFollow','true'); popup.classList.remove('active'); });

})();
</script>
</body>
</html>
