<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üõ†Ô∏è ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä | ŸÖŸáŸÜÿØÿ≥ ŸÖÿ≠ŸÖÿØ ÿ≠ŸÖÿßÿØ</title>
  <!-- ÿ≤ÿ± ŸÖÿ™ÿßÿ®ÿπÿ© ŸÅŸäÿ≥ÿ®ŸàŸÉ -->
<div style="margin-top:10px; text-align:center;">
  <div class="fb-follow"
      data-href="https://www.facebook.com/en.mohamed.nasr"
      data-layout="button"
      data-size="large"
      data-show-faces="false">
  </div>
</div>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
  <style>
    :root {
      --brand: #00e0a4;
      --bg: #0f1115;
      --panel: #151923;
      --text: #e9eef3;
      --border: #2a2f3a;
      --error: #ff4757;
      --success: #00e676;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      background: var(--bg); 
      color: var(--text); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
    }
    header { 
      padding: 20px; 
      text-align: center; 
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #0f1115 0%, #1a1f2e 100%);
    }
    h1 { 
      margin: 0 0 8px; 
      color: var(--brand); 
      font-weight: 700; 
      font-size: clamp(18px, 4vw, 24px);
    }
    .subtitle {
      color: #9fb0c3;
      font-size: clamp(12px, 2.5vw, 14px);
      margin: 8px 0;
    }
    main { 
      max-width: 1200px; 
      margin: 24px auto; 
      padding: 0 16px; 
    }
    .card { 
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .card h3 {
      color: var(--brand);
      margin-bottom: 12px;
      font-size: 18px;
    }
    
    /* Drop Zone */
    #dropZone {
      border: 3px dashed var(--brand);
      border-radius: 16px;
      padding: 60px 20px;
      text-align: center;
      background: linear-gradient(135deg, #0c0f14 0%, #151923 100%);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    #dropZone::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(0, 224, 164, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    #dropZone:hover::after {
      opacity: 1;
    }
    #dropZone.dragover {
      background: rgba(0, 224, 164, 0.15);
      border-color: var(--success);
      border-style: solid;
      transform: scale(1.02);
      box-shadow: 0 0 30px rgba(0, 224, 164, 0.3);
    }
    #dropZone.dragover::after {
      opacity: 1;
    }
    .drop-icon {
      font-size: 64px;
      display: block;
      margin-bottom: 16px;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    #dropZone.dragover .drop-icon {
      animation: bounce 0.5s ease infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    .drop-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 12px;
    }
    .drop-hint {
      font-size: 14px;
      color: #7a8a9a;
      margin-bottom: 8px;
    }
    .drop-limit {
      font-size: 12px;
      color: #5a6a7a;
      margin-top: 8px;
    }
    .file-count {
      display: inline-block;
      background: var(--brand);
      color: #02130e;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 13px;
      margin-top: 12px;
    }
    #picker { display: none; }
    
    /* Controls */
    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .control-item label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #b4c7d4;
    }
    select, input[type="number"] {
      width: 100%;
      background: #0c0f14;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--brand);
    }
    
    .range-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    input[type="range"] {
      flex: 1;
      height: 6px;
      background: #0c0f14;
      border-radius: 10px;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--brand);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--brand);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    .range-value {
      min-width: 50px;
      text-align: center;
      font-weight: 700;
      color: var(--brand);
    }
    
    /* Buttons */
    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .btn {
      flex: 1;
      min-width: 150px;
      background: var(--brand);
      color: #02130e;
      border: 0;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 224, 164, 0.4);
    }
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #2a2f3a;
      color: var(--text);
    }
    .btn-danger {
      background: var(--error);
      color: white;
    }
    
    /* Progress */
    .progress-container {
      margin: 16px 0;
      position: relative;
    }
    .progress-bar-container {
      width: 100%;
      height: 20px;
      background: #0c0f14;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), #00b8ff, var(--brand));
      background-size: 200% 100%;
      border-radius: 10px;
      animation: progressAnim 2s linear infinite;
      transition: width 0.3s ease;
      width: 0%;
    }
    @keyframes progressAnim {
      0% { background-position: 0% 0; }
      100% { background-position: 200% 0; }
    }
    
    .status-text {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 13px;
      color: #7a8a9a;
    }
    .status-text .spin {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* AI Status */
    #aiStatus {
      text-align: center;
      margin: 16px 0;
      padding: 12px;
      background: rgba(0, 224, 164, 0.1);
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      color: var(--brand);
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .gallery.empty::after {
      content: 'üì∑ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ± ŸÑŸÑÿπÿ±ÿ∂ - ŸÇŸÖ ÿ®ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ± ÿ£ŸàŸÑÿßŸã';
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #5a6a7a;
      font-size: 16px;
    }
    .thumb-card {
      background: #0c0f14;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .thumb-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 224, 164, 0.2);
    }
    .thumb-header {
      padding: 10px;
      background: #151923;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: #9fb0c3;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .thumb-size {
      font-size: 11px;
      color: #7a8a9a;
    }
    .thumb-canvas-container {
      position: relative;
      width: 100%;
      padding-top: 75%;
      background: #000;
    }
    .thumb-canvas-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .comparison-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 224, 164, 0.9);
      color: #02130e;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      z-index: 10;
      transition: transform 0.2s ease;
    }
    .comparison-toggle:hover {
      transform: scale(1.05);
    }
    
    /* Thumb Controls */
    .thumb-controls {
      padding: 12px;
      background: #0d1118;
    }
    .thumb-controls .control-row {
      margin-bottom: 10px;
    }
    .thumb-controls label {
      font-size: 11px;
      color: #7a8a9a;
      display: block;
      margin-bottom: 4px;
    }
    .thumb-controls input[type="range"] {
      width: 100%;
      height: 4px;
    }
    .thumb-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .thumb-actions .btn {
      min-width: auto;
      padding: 8px 12px;
      font-size: 12px;
      flex: 1;
    }
    
    /* Thumb Stats */
    .thumb-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
      padding: 10px;
      background: rgba(0, 224, 164, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(0, 224, 164, 0.1);
    }
    .thumb-stat {
      text-align: center;
    }
    .thumb-stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 2px;
    }
    .thumb-stat-label {
      font-size: 10px;
      color: #7a8a9a;
    }
    
    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .stat-card {
      background: #0c0f14;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: transform 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 12px;
      color: #7a8a9a;
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--error); }
    .toast.warning { border-left: 4px solid #ffa502; }
    
    /* User Counter */
    #activeUsers {
      margin-top: 12px;
      font-size: 16px;
      color: var(--brand);
      font-weight: 700;
    }
    
    /* Privacy Note */
    .privacy-note {
      margin-top: 12px;
      padding: 12px;
      background: rgba(0, 224, 164, 0.1);
      border-radius: 10px;
      color: var(--brand);
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 24px;
      color: #7a8a9a;
      font-size: 14px;
      border-top: 1px solid var(--border);
      margin-top: 40px;
    }
    footer a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 700;
      transition: color 0.3s ease;
    }
    footer a:hover {
      color: #00b8ff;
    }
    
    /* Theme Toggle */
    #themeToggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--brand);
      color: #02130e;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    #themeToggle:hover {
      transform: scale(1.1) rotate(20deg);
    }
    
    /* Sound Toggle */
    #soundToggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--brand);
      color: #02130e;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    #soundToggle:hover {
      transform: scale(1.1);
    }
    
    /* Light Theme */
    body.light-theme {
      --bg: #f5f5f5;
      --panel: #ffffff;
      --text: #1a1a1a;
      --border: #e0e0e0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .control-grid {
        grid-template-columns: 1fr;
      }
      .btn-group {
        flex-direction: column;
      }
      .btn {
        min-width: 100%;
      }
      .gallery {
        grid-template-columns: 1fr;
      }
      #themeToggle, #soundToggle {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      .drop-icon {
        font-size: 48px;
      }
      #dropZone {
        padding: 40px 15px;
      }
    }
    
    @media (max-width: 480px) {
      main {
        padding: 0 8px;
      }
      .card {
        padding: 12px;
        border-radius: 12px;
      }
      h1 {
        font-size: 16px;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Live Preview Indicator */
    .live-preview-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Oath Modal */
    .oath-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .oath-modal.show {
      opacity: 1;
      visibility: visible;
    }
    .oath-content {
      background: var(--panel);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 224, 164, 0.3);
      transform: translate(0, 0);
      animation: floatOath 4s ease-in-out infinite;
    }
    @keyframes floatOath {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .oath-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(0, 224, 164, 0.2) 0%, transparent 70%);
      z-index: -1;
      transition: background 0.3s ease;
    }
    .oath-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 24px;
      line-height: 1.8;
    }
    .oath-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    .oath-checkbox input {
      width: 20px;
      height: 20px;
      accent-color: var(--brand);
    }
    .oath-checkbox label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .oath-btn-group {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    .oath-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 12px;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .oath-btn-follow {
      background: #1877f2;
      color: white;
    }
    .oath-btn-follow:hover {
      background: #166fe5;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(24, 119, 242, 0.4);
    }
    .oath-btn-agree {
      background: var(--brand);
      color: #02130e;
    }
    .oath-btn-agree:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .oath-btn-agree:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 224, 164, 0.4);
    }
  </style>
</head>
<body>
  <button id="themeToggle" title="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸàÿ∂ÿπ">üåô</button>
  <button id="soundToggle" title="ÿ™ÿ¥ÿ∫ŸäŸÑ/ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿµŸàÿ™">üîä</button>

  <!-- Oath Modal -->
  <div id="oathModal" class="oath-modal">
    <div class="oath-content">
      <div class="oath-text">
        ÿ£ŸÇÿ≥ŸÖ ÿ®ÿßŸÑŸÑŸá ÿßŸÑÿπÿ∏ŸäŸÖ ÿ£ŸÜŸÜŸä ÿ£ÿ™ÿßÿ®ÿπ ÿßŸÑŸÖŸáŸÜÿØÿ≥ ŸÖÿ≠ŸÖÿØ ÿ≠ŸÖÿßÿØ ÿπŸÑŸâ ÿµŸÅÿ≠ÿ™Ÿá ÿπŸÑŸâ ŸÅŸäÿ≥ÿ®ŸàŸÉ Ÿàÿ•ŸÑÿß ÿ£ŸÑÿ∫Ÿâ ŸÖÿ™ÿßÿ®ÿπÿ™Ÿá ÿ®ÿπÿØ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸä ŸÑŸáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ©ÿå Ÿàÿ•ŸÜ ŸÑŸÖ ÿ£ÿ™ÿßÿ®ÿπŸá ÿ£ŸÉŸàŸÜ ÿ∏ÿßŸÑŸÖŸãÿß ŸÑŸá Ÿàÿ∏ÿßŸÑŸÖŸãÿß ŸÑŸÜŸÅÿ≥Ÿä Ÿàÿ≥ÿ£ÿ™ÿ≠ŸÖŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸäŸàŸÖ ÿßŸÑÿØŸäŸÜ.
      </div>
      <div class="oath-checkbox">
        <input type="checkbox" id="oathCheck">
        <label for="oathCheck">ÿ£ŸÇÿ≥ŸÖ ÿπŸÑŸâ ÿ∞ŸÑŸÉ</label>
      </div>
      <div class="oath-btn-group">
        <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" class="oath-btn oath-btn-follow">
          <span>üìò</span> ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸáŸÜÿØÿ≥ ŸÑŸÖÿ™ÿßÿ®ÿπÿ™Ÿá ÿ£ŸàŸÑÿßŸã
        </a>
        <button id="oathAgree" class="oath-btn oath-btn-agree" disabled>ŸÖŸàÿßŸÅŸÇ</button>
      </div>
    </div>
  </div>
<!-- ÿ≤ÿ± ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿØÿßÿÆŸÑ ÿßŸÑŸÇÿ≥ŸÖ -->
<div style="margin-top:15px;">
  <div class="fb-follow"
      data-href="https://www.facebook.com/en.mohamed.nasr"
      data-layout="button"
      data-size="large"
      data-show-faces="false">
  </div>
</div>

  <header>
    <h1>üõ†Ô∏è ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿ•ÿµÿ∑ŸÜÿßÿπŸä | ŸÖŸÜ ŸÖŸáŸÜÿØÿ≥ ŸÖÿ≠ŸÖÿØ ÿ≠ŸÖÿßÿØ</h1>
    <div class="subtitle">ŸÑŸà ÿ≠ÿ∂ÿ±ÿ™ŸÉ ÿßÿ≥ÿ™ŸÅÿØÿ™ ÿ®ÿ£Ÿä ÿ¥ŸÉŸÑ ŸÖŸÜ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ŸÖŸÜ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ© ÿ•ÿØÿπŸä ŸÑŸä ÿ±ÿ®ŸÖÿß ÿØÿπŸàÿ™ŸÉ ŸÖÿ≥ÿ™ÿ¨ÿßÿ®ÿ© </div>
    <div id="activeUsers">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÜÿ¥ÿ∑ŸàŸÜ: <span id="userCount">...</span></div>
  </header>

  <main>
    <!-- Upload Section -->
    <div class="card">
      <div id="dropZone">
        <span class="drop-icon">üì§</span>
        <div class="drop-text">ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ÿßŸÑÿµŸàÿ± ŸáŸÜÿß</div>
        <div class="drop-hint">ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ŸÉ</div>
        <div class="drop-limit">ŸäÿØÿπŸÖ: JPEG, PNG, WebP | ÿ≠ÿ™Ÿâ 50 ÿµŸàÿ±ÿ© | ÿ£ŸÇÿµŸâ ÿ≠ÿ¨ŸÖ ŸÑŸÉŸÑ ÿµŸàÿ±ÿ©: 10MB</div>
        <div class="file-count" id="fileCount" style="display: none;">
          <span id="fileCountNum">0</span> ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÖŸÑÿ©
        </div>
      </div>
      <input id="picker" type="file" accept="image/jpeg,image/png,image/webp" multiple>
      <div class="privacy-note">
        üîí ÿ≠ÿ∂ÿ±ÿ™ŸÉ ÿ®ÿ™ÿ™ŸÖÿ™ÿπ ÿ®ÿÆÿµŸàÿµŸäÿ© ŸÉÿßŸÖŸÑÿ© - ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ± ÿ™ŸèÿπÿßŸÑÿ¨ ŸÖÿ≠ŸÑŸäŸãÿß ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ ŸàŸÑÿß ÿ™Ÿèÿ±ÿ≥ŸÑ ŸÑÿ£Ÿä ÿÆÿßÿØŸÖ
      </div>
    </div>

    <!-- AI Detection Methods -->
    <div class="card">
      <h3>‚öôÔ∏è ÿ∑ÿ±ŸÇ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑŸÖÿßÿ¶Ÿäÿ© ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä</h3>
      <div class="control-grid">
        <div class="control-item">
          <label>ü§ñ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ•ÿ≤ÿßŸÑÿ©:</label>
          <select id="removalMethod">
            <option value="manual" selected>Manual Crop - ÿßŸÑŸÇÿµ ÿßŸÑŸäÿØŸàŸä (ÿ£ÿ≥ÿ±ÿπ)</option>
          </select>
        </div>
        
        <div class="control-item">
          <label>‚ú® Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ:</label>
          <select id="enhanceMode">
            <option value="4k-upscale" selected>4K Upscaling - ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¨ŸàÿØÿ© ÿ•ŸÑŸâ 4K</option>
          </select>
        </div>
        
        <div class="control-item">
          <label>üé® ÿ¨ŸàÿØÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨:</label>
          <select id="outputQuality">
            <option value="1.0">ÿ£ŸÇÿµŸâ ÿ¨ŸàÿØÿ© (100%)</option>
            <option value="0.95" selected>ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã (95%)</option>
            <option value="0.85">ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ© (85%)</option>
            <option value="0.75">ÿ¨ŸàÿØÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© - ÿ≠ÿ¨ŸÖ ÿ£ÿµÿ∫ÿ± (75%)</option>
          </select>
        </div>

        <div class="control-item">
          <label>üìÅ ÿµŸäÿ∫ÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨:</label>
          <select id="outputFormat">
            <option value="jpeg" selected>JPEG (ÿ≠ÿ¨ŸÖ ÿ£ÿµÿ∫ÿ±)</option>
            <option value="png">PNG (ÿ¨ŸàÿØÿ© ÿ£ÿπŸÑŸâ)</option>
            <option value="webp">WebP (ÿ™Ÿàÿßÿ≤ŸÜ ŸÖÿ´ÿßŸÑŸä)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Manual Cropping Controls -->
    <div class="card">
      <h3>‚úÇÔ∏è ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸäÿØŸàŸä ÿ®ÿßŸÑŸÇÿµ <span class="live-preview-indicator"></span> ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©</h3>
      <div class="control-grid">
        <div class="control-item">
          <label>ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÇÿµ ÿßŸÑÿπŸÖŸàÿØŸä:</label>
          <select id="vertSide">
            <option value="right">ŸäŸÖŸäŸÜ ‚Üê</option>
            <option value="left">Ÿäÿ≥ÿßÿ± ‚Üí</option>
          </select>
        </div>
        
        <div class="control-item">
          <label>ÿπÿ±ÿ∂ ÿßŸÑŸÇÿµ ÿßŸÑÿπŸÖŸàÿØŸä:</label>
          <div class="range-control">
            <input id="vertCut" type="range" min="0" max="30" step="0.5" value="2">
            <span class="range-value"><span id="vertVal">2</span>%</span>
          </div>
        </div>
        
        <div class="control-item">
          <label>ŸÇÿµ ÿπŸÑŸàŸä:</label>
          <div class="range-control">
            <input id="topCut" type="range" min="0" max="30" step="0.5" value="0">
            <span class="range-value"><span id="topVal">0</span>%</span>
          </div>
        </div>
        
        <div class="control-item">
          <label>ŸÇÿµ ÿ≥ŸÅŸÑŸä:</label>
          <div class="range-control">
            <input id="bottomCut" type="range" min="0" max="30" step="0.5" value="0">
            <span class="range-value"><span id="bottomVal">0</span>%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="card">
      <div class="btn-group">
        <button class="btn" id="btnProcess">üîÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÉŸÑ</button>
        <button class="btn btn-secondary" id="btnDownload">‚¨áÔ∏è ÿ™ŸÜÿ≤ŸäŸÑ ÿßŸÑŸÉŸÑ</button>
        <button class="btn btn-secondary" id="btnUndo">‚Ü©Ô∏è ÿ™ÿ±ÿßÿ¨ÿπ</button>
        <button class="btn btn-danger" id="btnClear">üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸÑ</button>
      </div>
    </div>

    <!-- Progress -->
    <div class="card">
      <div class="progress-container">
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status-text">
          <span id="statusText">ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ</span>
          <span id="statusDetails"></span>
        </div>
      </div>
      <div id="aiStatus">ü§ñ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±...</div>
    </div>

    <!-- Gallery -->
    <div class="card">
      <h3>üñºÔ∏è ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ± (ŸÇÿ®ŸÑ Ÿàÿ®ÿπÿØ)</h3>
      <div id="gallery" class="gallery empty"></div>
    </div>

    <!-- Statistics -->
    <div class="card">
      <h3>üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statImages">0</div>
          <div class="stat-label">ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÖŸÑÿ©</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statProcessed">0</div>
          <div class="stat-label">ÿ™ŸÖÿ™ ŸÖÿπÿßŸÑÿ¨ÿ™Ÿáÿß</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTime">0s</div>
          <div class="stat-label">ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statSize">0 MB</div>
          <div class="stat-label">ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä</div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>ÿ®ÿ±ŸÖÿ¨ÿ© Ÿàÿ™ÿµŸÖŸäŸÖ <strong>ÿßŸÑŸÖŸáŸÜÿØÿ≥ ŸÖÿ≠ŸÖÿØ ÿ≠ŸÖÿßÿØ</strong></p>
    <p>ÿ™ÿßÿ®ÿπŸÜŸä ÿπŸÑŸâ: üëâ <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">facebook.com/en.mohamed.nasr</a></p>
   <p style="margin-top: 8px; font-size: 12px; opacity: 0.7;">
 ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ¬© <span id="year"></span>
</p>
<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>

  </footer>

  <audio id="bgMusic" loop>
    <source src="https://mohamednasr5.github.io/logo/bg.mp3" type="audio/mpeg">
  </audio>

  <script>
    (async () => {
      'use strict';

      // ==================== Constants ====================
      const MAX_FILES = 50;
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
      const MIME_MAP = {
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'webp': 'image/webp'
      };
      const OATH_COOKIE_NAME = 'oath_accepted';
      const OATH_COOKIE_DURATION = 3 * 24 * 60 * 60 * 1000; // 3 days in milliseconds
      
      // ==================== State Management ====================
      const state = {
        files: [],
        items: [],
        processedCount: 0,
        totalSize: 0,
        startTime: null,
        aiModel: null,
        isMuted: false,
        history: [],
        activeUsers: 0,
        opencvLoaded: false,
        espcnModel: null,
        livePreviewEnabled: true,
        previewTimeout: null
      };

      // ==================== DOM Elements ====================
      const el = {
        dropZone: document.getElementById('dropZone'),
        picker: document.getElementById('picker'),
        gallery: document.getElementById('gallery'),
        progressBar: document.getElementById('progressBar'),
        statusText: document.getElementById('statusText'),
        statusDetails: document.getElementById('statusDetails'),
        aiStatus: document.getElementById('aiStatus'),
        userCount: document.getElementById('userCount'),
        bgMusic: document.getElementById('bgMusic'),
        soundToggle: document.getElementById('soundToggle'),
        themeToggle: document.getElementById('themeToggle'),
        fileCount: document.getElementById('fileCount'),
        fileCountNum: document.getElementById('fileCountNum'),
        oathModal: document.getElementById('oathModal'),
        oathCheck: document.getElementById('oathCheck'),
        oathAgree: document.getElementById('oathAgree'),
        
        // Controls
        removalMethod: document.getElementById('removalMethod'),
        enhanceMode: document.getElementById('enhanceMode'),
        outputQuality: document.getElementById('outputQuality'),
        outputFormat: document.getElementById('outputFormat'),
        vertSide: document.getElementById('vertSide'),
        vertCut: document.getElementById('vertCut'),
        topCut: document.getElementById('topCut'),
        bottomCut: document.getElementById('bottomCut'),
        vertVal: document.getElementById('vertVal'),
        topVal: document.getElementById('topVal'),
        bottomVal: document.getElementById('bottomVal'),
        
        // Buttons
        btnProcess: document.getElementById('btnProcess'),
        btnDownload: document.getElementById('btnDownload'),
        btnUndo: document.getElementById('btnUndo'),
        btnClear: document.getElementById('btnClear'),
        
        // Stats
        statImages: document.getElementById('statImages'),
        statProcessed: document.getElementById('statProcessed'),
        statTime: document.getElementById('statTime'),
        statSize: document.getElementById('statSize')
      };

      // ==================== Utility Functions ====================
      const utils = {
        clamp: (val, min, max) => Math.max(min, Math.min(max, val)),
        
        formatBytes: (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        formatTime: (seconds) => {
          if (seconds < 60) return `${seconds.toFixed(1)}s`;
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}m ${secs}s`;
        },
        
        showToast: (message, type = 'success') => {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => toast.classList.add('show'), 100);
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        },
        
        validateFile: (file) => {
          if (!ALLOWED_TYPES.includes(file.type)) {
            throw new Error(`ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ ${file.name} ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ`);
          }
          if (file.size > MAX_FILE_SIZE) {
            throw new Error(`ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ${file.name} ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ${utils.formatBytes(MAX_FILE_SIZE)})`);
          }
          return true;
        },
        
        loadImage: (file) => {
          return new Promise((resolve, reject) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = () => {
              URL.revokeObjectURL(url);
              resolve(img);
            };
            img.onerror = () => {
              URL.revokeObjectURL(url);
              reject(new Error(`ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ${file.name}`));
            };
            img.src = url;
          });
        },

        updateProgress: (percentage, text = '') => {
          el.progressBar.style.width = `${percentage}%`;
          if (text) {
            el.statusText.textContent = text;
          }
        },

        getCookie: (name) => {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return null;
        },

        setCookie: (name, value, duration) => {
          const expires = new Date(Date.now() + duration).toUTCString();
          document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Strict`;
        }
      };

      // ==================== Oath Modal Management ====================
      const oathModal = {
        init: () => {
          // Check if oath cookie exists
          if (!utils.getCookie(OATH_COOKIE_NAME)) {
            el.oathModal.classList.add('show');
            document.body.style.overflow = 'hidden';
          } else {
            el.oathModal.style.display = 'none';
          }

          // Enable/disable agree button based on checkbox
          el.oathCheck.addEventListener('change', () => {
            el.oathAgree.disabled = !el.oathCheck.checked;
          });

          // Handle agree button click
          el.oathAgree.addEventListener('click', () => {
            if (el.oathCheck.checked) {
              utils.setCookie(OATH_COOKIE_NAME, 'accepted', OATH_COOKIE_DURATION);
              el.oathModal.classList.remove('show');
              document.body.style.overflow = '';
              utils.showToast('ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑŸÇÿ≥ŸÖÿå ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿØÿßÿ©', 'success');
            }
          });

          // Mouse move animation for oath modal
          el.oathModal.addEventListener('mousemove', (e) => {
            const rect = el.oathModal.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            el.oathModal.querySelector('.oath-content').style.setProperty('--mouse-x', `${x}%`);
            el.oathModal.querySelector('.oath-content').style.setProperty('--mouse-y', `${y}%`);
          });
        }
      };

      // ==================== ESPCN Model Integration ====================
      const espcnProcessor = {
        init: async () => {
          try {
            utils.updateProgress(10, 'üîÑ ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ESPCN...');
            el.aiStatus.innerHTML = '<span class="spin">üîÑ</span> ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ESPCN ŸÑŸÑÿ™ÿ≠ÿ≥ŸäŸÜ 4K...';
            
            try {
              state.espcnModel = await tf.loadGraphModel('https://mohamednasr5.github.io/logo/ESPCN_x4/model.json');
              utils.updateProgress(100, '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ESPCN');
              el.aiStatus.textContent = '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ESPCN ŸÑŸÑÿ™ÿ≠ÿ≥ŸäŸÜ 4K';
              console.log('‚úÖ ESPCN model loaded successfully');
              return true;
            } catch (modelError) {
              console.log('ESPCN model not available, using advanced OpenCV methods');
              return false;
            }
            
          } catch (error) {
            console.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ESPCN:', error);
            el.aiStatus.textContent = '‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ESPCN - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∑ÿ±ŸÇ ÿßŸÑÿ®ÿØŸäŸÑÿ©';
            utils.showToast('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ESPCNÿå ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∑ÿ±ŸÇ ÿßŸÑÿ™ŸÇŸÑŸäÿØŸäÿ©', 'warning');
            return false;
          }
        },

        upscaleTo4K: async (canvas) => {
          if (!state.espcnModel) {
            return await opencvProcessor.enhanceImage(canvas, '4k-upscale');
          }

          try {
            const tensor = tf.browser.fromPixels(canvas)
              .resizeNearestNeighbor([canvas.height, canvas.width])
              .toFloat()
              .div(255.0)
              .expandDims(0);

            const prediction = state.espcnModel.predict(tensor);
            
            const upscaled = await tf.browser.toPixels(
              prediction.squeeze().mul(255).cast('int32')
            );
            
            const output = document.createElement('canvas');
            output.width = canvas.width * 4;
            output.height = canvas.height * 4;
            const ctx = output.getContext('2d');
            const imageData = new ImageData(upscaled, output.width, output.height);
            ctx.putImageData(imageData, 0, 0);
            
            tensor.dispose();
            prediction.dispose();
            
            return output;
          } catch (error) {
            console.error('ESPCN upscaling error:', error);
            return await opencvProcessor.enhanceImage(canvas, '4k-upscale');
          }
        }
      };

      // ==================== OpenCV Integration ====================
      const opencvProcessor = {
        init: () => {
          return new Promise((resolve, reject) => {
            if (cv.getBuildInformation) {
              state.opencvLoaded = true;
              console.log('‚úÖ OpenCV.js loaded successfully');
              resolve();
              return;
            }
            
            const checkOpenCV = setInterval(() => {
              if (cv.getBuildInformation) {
                clearInterval(checkOpenCV);
                state.opencvLoaded = true;
                console.log('‚úÖ OpenCV.js loaded successfully');
                resolve();
              }
            }, 100);
            
            setTimeout(() => {
              clearInterval(checkOpenCV);
              reject(new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ OpenCV.js'));
            }, 10000);
          });
        },

        enhanceImage: (canvas, mode) => {
          return new Promise((resolve) => {
            if (!state.opencvLoaded) {
              resolve(canvas);
              return;
            }

            try {
              const src = cv.imread(canvas);
              const dst = new cv.Mat();
              
              switch(mode) {
                case '4k-upscale':
                  const targetWidth = Math.min(3840, canvas.width * 4);
                  const targetHeight = Math.min(2160, canvas.height * 4);
                  cv.resize(src, dst, new cv.Size(targetWidth, targetHeight), 0, 0, cv.INTER_LANCZOS4);
                  const sharpened = new cv.Mat();
                  const kernel = new cv.Mat(3, 3, cv.CV_32FC1);
                  kernel.data32F.set([0, -0.5, 0, -0.5, 3, -0.5, 0, -0.5, 0]);
                  cv.filter2D(dst, sharpened, -1, kernel);
                  const final = new cv.Mat();
                  cv.bilateralFilter(sharpened, final, 9, 75, 75);
                  const output = document.createElement('canvas');
                  output.width = targetWidth;
                  output.height = targetHeight;
                  cv.imshow(output, final);
                  sharpened.delete();
                  final.delete();
                  kernel.delete();
                  src.delete();
                  dst.delete();
                  resolve(output);
                  break;
                  
                case 'ai-upscale':
                  cv.resize(src, dst, new cv.Size(canvas.width * 2, canvas.height * 2), 0, 0, cv.INTER_CUBIC);
                  cv.resize(dst, dst, new cv.Size(canvas.width, canvas.height), 0, 0, cv.INTER_AREA);
                  const output2 = document.createElement('canvas');
                  output2.width = canvas.width;
                  output2.height = canvas.height;
                  cv.imshow(output2, dst);
                  src.delete();
                  dst.delete();
                  resolve(output2);
                  break;
                  
                case 'denoise':
                  cv.fastNlMeansDenoisingColored(src, dst, 10, 10, 7, 21);
                  const output3 = document.createElement('canvas');
                  output3.width = canvas.width;
                  output3.height = canvas.height;
                  cv.imshow(output3, dst);
                  src.delete();
                  dst.delete();
                  resolve(output3);
                  break;
                  
                case 'sharpen':
                  const kernel2 = new cv.Mat(3, 3, cv.CV_32FC1);
                  kernel2.data32F.set([0, -1, 0, -1, 5, -1, 0, -1, 0]);
                  cv.filter2D(src, dst, -1, kernel2);
                  const output4 = document.createElement('canvas');
                  output4.width = canvas.width;
                  output4.height = canvas.height;
                  cv.imshow(output4, dst);
                  src.delete();
                  dst.delete();
                  kernel2.delete();
                  resolve(output4);
                  break;
                  
                default:
                  resolve(canvas);
                  break;
              }
              
            } catch (error) {
              console.error('OpenCV enhancement error:', error);
              resolve(canvas);
            }
          });
        }
      };

      // ==================== Image Processing ====================
      const imageProcessing = {
        cropImage: (img, opts) => {
          const { verticalPercent = 0, bottomPercent = 0, topPercent = 0, side = 'right' } = opts;
          
          const vpx = utils.clamp(verticalPercent / 100, 0, 0.95);
          const bpx = utils.clamp(bottomPercent / 100, 0, 0.95);
          const tpx = utils.clamp(topPercent / 100, 0, 0.95);
          
          const sx = side === 'left' ? img.width * vpx : 0;
          const sy = img.height * tpx;
          const sw = img.width * (1 - vpx);
          const sh = img.height * (1 - bpx - tpx);
          
          const canvas = document.createElement('canvas');
          canvas.width = Math.max(1, Math.round(sw));
          canvas.height = Math.max(1, Math.round(sh));
          
          const ctx = canvas.getContext('2d', { alpha: false });
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
          
          return canvas;
        },
        
        processPreview: (idx) => {
          const item = state.items[idx];
          if (!item || item.processing) return;
          
          try {
            const opts = {
              verticalPercent: parseFloat(el.vertCut.value),
              bottomPercent: parseFloat(el.bottomCut.value),
              topPercent: parseFloat(el.topCut.value),
              side: el.vertSide.value
            };
            
            const preview = imageProcessing.cropImage(item.img, opts);
            
            const canvas = item.canvas;
            const scale = Math.min(1, 260 / Math.max(preview.width, preview.height));
            canvas.width = Math.max(1, Math.round(preview.width * scale));
            canvas.height = Math.max(1, Math.round(preview.height * scale));
            
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);
            
          } catch (error) {
            console.error('Preview error:', error);
          }
        },
        
        processOne: async (idx) => {
          const item = state.items[idx];
          if (!item || item.processing) return;
          
          item.processing = true;
          
          try {
            const opts = {
              verticalPercent: parseFloat(el.vertCut.value),
              bottomPercent: parseFloat(el.bottomCut.value),
              topPercent: parseFloat(el.topCut.value),
              side: el.vertSide.value
            };
            
            const cropped = imageProcessing.cropImage(item.img, opts);
            
            const enhanceMode = el.enhanceMode.value;
            
            if (enhanceMode === '4k-upscale') {
              item.processed = await espcnProcessor.upscaleTo4K(cropped);
            } else if (state.opencvLoaded && enhanceMode !== 'none') {
              item.processed = await opencvProcessor.enhanceImage(cropped, enhanceMode);
            } else {
              item.processed = cropped;
            }
            
            imageProcessing.updateThumbPreview(idx);
            
          } catch (error) {
            console.error(`ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ${idx + 1}:`, error);
            utils.showToast(`ŸÅÿ¥ŸÑÿ™ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ${idx + 1}`, 'error');
          } finally {
            item.processing = false;
          }
        },
        
        updateThumbPreview: (idx) => {
          const item = state.items[idx];
          if (!item || !item.canvas || !item.processed) return;
          
          const canvas = item.canvas;
          const src = item.showOriginal ? item.img : item.processed;
          
          const scale = Math.min(1, 260 / Math.max(src.width, src.height));
          canvas.width = Math.max(1, Math.round(src.width * scale));
          canvas.height = Math.max(1, Math.round(src.height * scale));
          
          const ctx = canvas.getContext('2d', { alpha: false });
          ctx.imageSmoothingQuality = 'high';
          
          if (src instanceof HTMLImageElement) {
            ctx.drawImage(src, 0, 0, canvas.width, canvas.height);
          } else {
            ctx.drawImage(src, 0, 0, canvas.width, canvas.height);
          }
        },
        
        processAll: async () => {
          if (state.items.length === 0) {
            utils.showToast('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ± ŸÑŸÑŸÖÿπÿßŸÑÿ¨ÿ©', 'warning');
            return;
          }
          
          el.aiStatus.innerHTML = '<span class="spin">üîÑ</span> ÿ¨ÿßÿ±Ÿç ŸÖÿπÿßŸÑÿ¨ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ±...';
          ui.disableActions(true);
          
          state.startTime = Date.now();
          state.processedCount = 0;
          
          for (let i = 0; i < state.items.length; i++) {
            await imageProcessing.processOne(i);
            state.processedCount++;
            
            const progress = (state.processedCount / state.items.length) * 100;
            utils.updateProgress(progress, `‚öôÔ∏è ÿ™ŸÖÿ™ ŸÖÿπÿßŸÑÿ¨ÿ© ${state.processedCount}/${state.items.length}`);
            el.statProcessed.textContent = state.processedCount;
            
            const elapsed = (Date.now() - state.startTime) / 1000;
            el.statTime.textContent = utils.formatTime(elapsed);
          }
          
          el.aiStatus.textContent = '‚úÖ ÿßŸÉÿ™ŸÖŸÑÿ™ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ±';
          utils.updateProgress(100, '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
          ui.disableActions(false);
          utils.showToast('ÿ™ŸÖÿ™ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ± ÿ®ŸÜÿ¨ÿßÿ≠! üéâ', 'success');
        }
      };

      // ==================== Live Preview Management ====================
      const livePreview = {
        init: () => {
          const controls = [el.vertCut, el.topCut, el.bottomCut, el.vertSide];
          
          controls.forEach(control => {
            control.addEventListener('input', () => {
              if (state.livePreviewEnabled && state.items.length > 0) {
                livePreview.updateAllPreviews();
              }
            });
          });
        },
        
        updateAllPreviews: () => {
          if (state.previewTimeout) {
            clearTimeout(state.previewTimeout);
          }
          
          state.previewTimeout = setTimeout(() => {
            state.items.forEach((_, idx) => {
              imageProcessing.processPreview(idx);
            });
          }, 100);
        }
      };

      // ==================== UI Management ====================
      const ui = {
        disableActions: (disabled) => {
          [el.btnProcess, el.btnDownload, el.btnUndo, el.btnClear].forEach(btn => {
            btn.disabled = disabled;
          });
        },
        
        createThumbCard: (file, idx) => {
          const card = document.createElement('div');
          card.className = 'thumb-card';
          
          const header = document.createElement('div');
          header.className = 'thumb-header';
          header.innerHTML = `
            <span>üì∑ ${file.name}</span>
            <span class="thumb-size">${utils.formatBytes(file.size)}</span>
          `;
          
          const canvasContainer = document.createElement('div');
          canvasContainer.className = 'thumb-canvas-container';
          
          const canvas = document.createElement('canvas');
          canvasContainer.appendChild(canvas);
          
          const compareBtn = document.createElement('button');
          compareBtn.className = 'comparison-toggle';
          compareBtn.textContent = 'üëÅÔ∏è ŸÇÿ®ŸÑ';
          compareBtn.addEventListener('click', () => {
            const item = state.items[idx];
            item.showOriginal = !item.showOriginal;
            compareBtn.textContent = item.showOriginal ? 'üëÅÔ∏è ÿ®ÿπÿØ' : 'üëÅÔ∏è ŸÇÿ®ŸÑ';
            imageProcessing.updateThumbPreview(idx);
          });
          canvasContainer.appendChild(compareBtn);
          
          const controls = document.createElement('div');
          controls.className = 'thumb-controls';
          
          const stats = document.createElement('div');
          stats.className = 'thumb-stats';
          stats.innerHTML = `
            <div class="thumb-stat">
              <div class="thumb-stat-value" id="thumb-size-${idx}">${file.width || '?'}x${file.height || '?'}</div>
              <div class="thumb-stat-label">ÿßŸÑÿ£ÿ®ÿπÿßÿØ</div>
            </div>
            <div class="thumb-stat">
              <div class="thumb-stat-value" id="thumb-quality-${idx}">4K</div>
              <div class="thumb-stat-label">ÿßŸÑÿ¨ŸàÿØÿ©</div>
            </div>
          `;
          
          const actions = document.createElement('div');
          actions.className = 'thumb-actions';
          actions.innerHTML = `
            <button class="btn process-btn">üîÑ ŸÖÿπÿßŸÑÿ¨ÿ©</button>
            <button class="btn btn-secondary save-btn">üíæ ÿ≠ŸÅÿ∏</button>
          `;
          
          controls.appendChild(stats);
          controls.appendChild(actions);
          
          card.appendChild(header);
          card.appendChild(canvasContainer);
          card.appendChild(controls);
          
          const processBtn = actions.querySelector('.process-btn');
          processBtn.addEventListener('click', () => imageProcessing.processOne(idx));
          
          const saveBtn = actions.querySelector('.save-btn');
          saveBtn.addEventListener('click', () => {
            const item = state.items[idx];
            if (!item.processed) {
              utils.showToast('Ÿäÿ¨ÿ® ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã', 'warning');
              return;
            }
            
            const quality = parseFloat(el.outputQuality.value);
            const format = el.outputFormat.value;
            const mimeType = MIME_MAP[format];
            
            item.processed.toBlob(blob => {
              const link = document.createElement('a');
              link.download = `mohamedhammad (${idx + 1}).${format}`;
              link.href = URL.createObjectURL(blob);
              link.click();
              URL.revokeObjectURL(link.href);
              utils.showToast(`ÿ™ŸÖ ÿ≠ŸÅÿ∏ mohamedhammad (${idx + 1})`, 'success');
            }, mimeType, quality);
          });
          
          state.items[idx].canvas = canvas;
          state.items[idx].showOriginal = false;
          
          return card;
        },
        
        updateStats: () => {
          el.statImages.textContent = state.items.length;
          el.statSize.textContent = utils.formatBytes(state.totalSize);
        }
      };

      // ==================== File Handling ====================
      const fileHandler = {
        handleFiles: async (files) => {
          const validFiles = [];
          const errors = [];
          
          for (const file of files) {
            try {
              utils.validateFile(file);
              validFiles.push(file);
            } catch (error) {
              errors.push(error.message);
            }
          }
          
          if (errors.length > 0) {
            utils.showToast(`ÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ ${errors.length} ŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠`, 'warning');
          }
          
          if (validFiles.length === 0) {
            utils.showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ± ÿµÿßŸÑÿ≠ÿ©', 'error');
            return;
          }
          
          const filesToProcess = validFiles.slice(0, MAX_FILES);
          if (validFiles.length > MAX_FILES) {
            utils.showToast(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ŸàŸÑ ${MAX_FILES} ÿµŸàÿ±ÿ© ŸÅŸÇÿ∑`, 'warning');
          }
          
          utils.updateProgress(10, 'üì• ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±...');
          el.aiStatus.innerHTML = '<span class="spin">üîÑ</span> ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±...';
          
          state.totalSize = filesToProcess.reduce((sum, f) => sum + f.size, 0);
          
          for (let i = 0; i < filesToProcess.length; i++) {
            const file = filesToProcess[i];
            
            try {
              const img = await utils.loadImage(file);
              
              state.items.push({
                file,
                img,
                processed: null,
                processing: false,
                canvas: null,
                showOriginal: false
              });
              
              const card = ui.createThumbCard(file, state.items.length - 1);
              el.gallery.appendChild(card);
              
              await imageProcessing.processOne(state.items.length - 1);
              
              const progress = 10 + ((i + 1) / filesToProcess.length) * 80;
              utils.updateProgress(progress, `üì• ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ${i + 1}/${filesToProcess.length}`);
              
            } catch (error) {
              console.error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©:', error);
              utils.showToast(`ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ${file.name}`, 'error');
            }
          }
          
          if (state.items.length > 0) {
            el.gallery.classList.remove('empty');
          }
          
          el.fileCount.style.display = 'inline-block';
          el.fileCountNum.textContent = state.items.length;
          
          ui.updateStats();
          
          utils.updateProgress(100, `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${state.items.length} ÿµŸàÿ±ÿ©`);
          el.aiStatus.textContent = `‚úÖ ÿ¨ÿßŸáÿ≤ ŸÑŸÑŸÖÿπÿßŸÑÿ¨ÿ© - ${state.items.length} ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÖŸÑÿ©`;
          
          utils.showToast(`ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${state.items.length} ÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ`, 'success');
        }
      };

      // ==================== Initialize App ====================
      const init = async () => {
        console.log('üöÄ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...');
        
        oathModal.init();
        await espcnProcessor.init();
        
        try {
          await opencvProcessor.init();
        } catch (error) {
          console.warn('OpenCV failed to load:', error);
        }
        
        dragDrop.init();
        audio.init();
        theme.init();
        userCounter.init();
        rangeSync.init();
        buttons.init();
        livePreview.init();
        
        el.aiStatus.textContent = '‚úÖ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ - ŸÇŸÖ ÿ®ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±';
        utils.updateProgress(100, 'ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
        
        console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠');
      };

      // ==================== Drag & Drop ====================
      const dragDrop = {
        init: () => {
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            el.dropZone.addEventListener(eventName, (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
          });
          
          ['dragenter', 'dragover'].forEach(eventName => {
            el.dropZone.addEventListener(eventName, () => {
              el.dropZone.classList.add('dragover');
            });
          });
          
          ['dragleave', 'drop'].forEach(eventName => {
            el.dropZone.addEventListener(eventName, () => {
              el.dropZone.classList.remove('dragover');
            });
          });
          
          el.dropZone.addEventListener('drop', (e) => {
            const files = Array.from(e.dataTransfer.files).filter(f => 
              ALLOWED_TYPES.includes(f.type)
            );
            
            if (files.length > 0) {
              fileHandler.handleFiles(files);
            } else {
              utils.showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ± ÿµÿßŸÑÿ≠ÿ©', 'warning');
            }
          });
          
          el.dropZone.addEventListener('click', () => {
            el.picker.click();
          });
          
          el.picker.addEventListener('change', () => {
            const files = Array.from(el.picker.files);
            if (files.length > 0) {
              fileHandler.handleFiles(files);
            }
          });
        }
      };

      // ==================== Audio Management ====================
      const audio = {
        init: () => {
          el.bgMusic.volume = 0.3;
          
          document.addEventListener('click', () => {
            if (el.bgMusic.paused && !state.isMuted) {
              el.bgMusic.play().catch(() => {});
            }
          }, { once: true });
          
          el.soundToggle.addEventListener('click', () => {
            state.isMuted = !state.isMuted;
            el.bgMusic.muted = state.isMuted;
            el.soundToggle.textContent = state.isMuted ? 'üîá' : 'üîä';
            
            if (!state.isMuted) {
              el.bgMusic.play().catch(() => {});
            } else {
              el.bgMusic.pause();
            }
          });
        }
      };

      // ==================== Theme Toggle ====================
      const theme = {
        init: () => {
          el.themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            el.themeToggle.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
          });
        }
      };

      // ==================== User Counter ====================
      const userCounter = {
        init: async () => {
          try {
            let count = Math.floor(Math.random() * (6254 - 1052 + 1)) + 1052;
            el.userCount.textContent = count.toLocaleString('ar-EG');
            
            setInterval(() => {
              const change = Math.floor(Math.random() * 10) - 5;
              count = Math.max(1052, Math.min(6254, count + change));
              el.userCount.textContent = count.toLocaleString('ar-EG');
            }, 5000);
          } catch (e) {
            el.userCount.textContent = '1,234';
          }
        }
      };

      // ==================== Range Sync ====================
      const rangeSync = {
        init: () => {
          const syncRange = (range, display) => {
            range.addEventListener('input', () => {
              display.textContent = range.value;
            });
          };
          
          syncRange(el.vertCut, el.vertVal);
          syncRange(el.topCut, el.topVal);
          syncRange(el.bottomCut, el.bottomVal);
        }
      };

      // ==================== Button Actions ====================
      const buttons = {
        init: () => {
          el.btnProcess.addEventListener('click', imageProcessing.processAll);
          
          el.btnDownload.addEventListener('click', async () => {
            if (state.items.length === 0) {
              utils.showToast('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ± ŸÑŸÑÿ™ŸÜÿ≤ŸäŸÑ', 'warning');
              return;
            }
            
            const quality = parseFloat(el.outputQuality.value);
            const format = el.outputFormat.value;
            const mimeType = MIME_MAP[format];
            
            for (let i = 0; i < state.items.length; i++) {
              const item = state.items[i];
              
              if (!item.processed) {
                await imageProcessing.processOne(i);
              }
              
              if (item.processed) {
                item.processed.toBlob(blob => {
                  const link = document.createElement('a');
                  link.download = `mohamedhammad (${i + 1}).${format}`;
                  link.href = URL.createObjectURL(blob);
                  link.click();
                  URL.revokeObjectURL(link.href);
                }, mimeType, quality);
                
                await new Promise(resolve => setTimeout(resolve, 100));
              }
            }
            
            utils.showToast('ÿ™ŸÖ ÿ™ŸÜÿ≤ŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ± ÿ®ÿßÿ≥ŸÖ mohamedhammad! üéâ', 'success');
          });
          
          el.btnClear.addEventListener('click', () => {
            if (state.items.length === 0) return;
            
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ±ÿü')) {
              state.items = [];
              state.processedCount = 0;
              state.totalSize = 0;
              el.gallery.innerHTML = '';
              el.gallery.classList.add('empty');
              el.fileCount.style.display = 'none';
              utils.updateProgress(0, 'ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
              el.aiStatus.textContent = 'ü§ñ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±...';
              ui.updateStats();
              utils.showToast('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ±', 'success');
            }
          });
          
          el.btnUndo.addEventListener('click', () => {
            utils.showToast('ŸÖŸäÿ≤ÿ© ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±', 'warning');
          });
        }
      };

      // Start the application
      init();
      
    })();
  </script>
  <!-- SDK ÿßŸÑÿ±ÿ≥ŸÖŸä ŸÖŸÜ ŸÅŸäÿ≥ÿ®ŸàŸÉ -->
<div id="fb-root"></div>
<script async defer crossorigin="anonymous"
  src="https://connect.facebook.net/ar_AR/sdk.js#xfbml=1&version=v20.0"></script>
</body>
</html>




