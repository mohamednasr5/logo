<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± 4K | Ù…Ù† Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</title>
<script src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
:root {--brand:#00e0a4;--bg:#0f1115;--panel:#151923;--text:#e9eef3;--border:#2a2f3a;}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial}
header{text-align:center;padding:20px;border-bottom:1px solid var(--border)}
h1{color:var(--brand)}
main{max-width:1100px;margin:20px auto;padding:10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
#dropZone{border:3px dashed var(--brand);border-radius:12px;text-align:center;padding:50px 20px;cursor:pointer;transition:.3s}
#dropZone.dragover{background:rgba(0,224,164,0.1)}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;margin-top:16px}
.thumb-card{background:#0c0f14;border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center}
.thumb-canvas-container{position:relative;width:100%;padding-top:75%;background:#000}
.thumb-canvas-container canvas{position:absolute;top:0;left:0;width:100%;height:100%}
.thumb-actions{margin-top:8px;display:flex;gap:8px}
.btn{flex:1;background:var(--brand);border:0;padding:10px;border-radius:10px;cursor:pointer;font-weight:bold}
.btn-secondary{background:#2a2f3a;color:var(--text)}
.range-control{display:flex;align-items:center;gap:8px;margin-top:8px}
.range-value{color:var(--brand);font-weight:bold}
progress{width:100%;height:16px}
</style>
</head>
<body>
<header>
<h1>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± 4K</h1>
<p>Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ | Ø¨Ø¯ÙˆÙ† API | Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙØ¹Ù„ÙŠ Ù…Ù† OpenCV</p>
</header>

<main>
<div class="card">
<div id="dropZone">ğŸ“¤ Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§</div>
<input id="picker" type="file" accept="image/*" multiple style="display:none">
<progress id="progressBar" value="0" max="100"></progress>
<p id="statusText">Ø¬Ø§Ù‡Ø²</p>
</div>

<div class="card">
<h3>âœ‚ï¸ ØªØ­ÙƒÙ… Ø¹Ø§Ù… Ø¨Ø§Ù„Ù‚Øµ</h3>
<div class="range-control">
<label>Ù‚Øµ Ø¹Ù„ÙˆÙŠ:</label>
<input id="topCut" type="range" min="0" max="30" step="0.5" value="0">
<span class="range-value" id="topVal">0%</span>
</div>
<div class="range-control">
<label>Ù‚Øµ Ø³ÙÙ„ÙŠ:</label>
<input id="bottomCut" type="range" min="0" max="30" step="0.5" value="0">
<span class="range-value" id="bottomVal">0%</span>
</div>
</div>

<div class="card">
<h3>ğŸ–¼ï¸ Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ù‚Ø¨Ù„ / Ø¨Ø¹Ø¯)</h3>
<div id="gallery" class="gallery"></div>
</div>
</main>

<script>
(async()=>{
'use strict';
const el={
dropZone:document.getElementById('dropZone'),
picker:document.getElementById('picker'),
gallery:document.getElementById('gallery'),
progressBar:document.getElementById('progressBar'),
statusText:document.getElementById('statusText'),
topCut:document.getElementById('topCut'),
bottomCut:document.getElementById('bottomCut'),
topVal:document.getElementById('topVal'),
bottomVal:document.getElementById('bottomVal')
};
const state={items:[],opencvReady:false,sr:null};

// ØªØ­Ù…ÙŠÙ„ OpenCV
function waitForCV(){
 return new Promise((resolve,reject)=>{
  let check=setInterval(()=>{
   if(cv && cv.getBuildInformation){
     clearInterval(check);
     resolve();
   }
  },200);
  setTimeout(()=>reject(new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ OpenCV")),10000);
 });
}

// ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±ÙØ¹ 4X
async function loadSuperRes(){
 state.sr=new cv.dnn.SuperResolution();
 await state.sr.readModel("https://raw.githubusercontent.com/opencv/opencv_contrib/4.x/modules/dnn_superres/samples/ESPCN_x4.pb");
 state.sr.setModel("espcn",4);
 console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ESPCN x4");
}

// Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ 4x
async function upscale4x(canvas){
 return new Promise(resolve=>{
  try{
   const src=cv.imread(canvas);
   const dst=new cv.Mat();
   state.sr.upsample(src,dst);
   const out=document.createElement('canvas');
   out.width=dst.cols;out.height=dst.rows;
   cv.imshow(out,dst);
   src.delete();dst.delete();
   resolve(out);
  }catch(e){
   console.error(e);
   resolve(canvas);
  }
 });
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚Øµ
function cropImage(img,topPercent,bottomPercent){
 const t=img.height*(topPercent/100);
 const b=img.height*(bottomPercent/100);
 const h=img.height - t - b;
 const canvas=document.createElement('canvas');
 canvas.width=img.width;
 canvas.height=h;
 const ctx=canvas.getContext('2d');
 ctx.drawImage(img,0,t,img.width,h,0,0,img.width,h);
 return canvas;
}

// Ø¹Ø±Ø¶ Ù…ØµØºØ±Ø§Øª
function updateThumb(idx){
 const item=state.items[idx];
 if(!item) return;
 const canvas=item.canvas;
 const ctx=canvas.getContext('2d');
 const src=item.showOriginal?item.img:item.processed;
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.drawImage(src,0,0,canvas.width,canvas.height);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©
async function processOne(idx){
 const item=state.items[idx];
 const top=parseFloat(el.topCut.value);
 const bottom=parseFloat(el.bottomCut.value);
 const cropped=cropImage(item.img,top,bottom);
 const upscaled=await upscale4x(cropped);
 item.processed=upscaled;
 updateThumb(idx);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
async function handleFiles(files){
 state.items=[];
 el.gallery.innerHTML="";
 for(let i=0;i<files.length;i++){
  const file=files[i];
  const img=new Image();
  img.src=URL.createObjectURL(file);
  await new Promise(res=>img.onload=res);
  const item={img,processed:null,showOriginal:false};
  const card=document.createElement('div');
  card.className='thumb-card';
  const cont=document.createElement('div');
  cont.className='thumb-canvas-container';
  const canvas=document.createElement('canvas');
  cont.appendChild(canvas);
  card.appendChild(cont);
  const btns=document.createElement('div');
  btns.className='thumb-actions';
  const btn1=document.createElement('button');
  btn1.className='btn';btn1.textContent='ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø©';
  const btn2=document.createElement('button');
  btn2.className='btn-secondary';btn2.textContent='ğŸ‘ï¸ Ù‚Ø¨Ù„/Ø¨Ø¹Ø¯';
  btns.appendChild(btn1);btns.appendChild(btn2);
  card.appendChild(btns);
  el.gallery.appendChild(card);
  item.canvas=canvas;
  canvas.width=250;canvas.height=250;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  state.items.push(item);
  btn1.onclick=()=>processOne(i);
  btn2.onclick=()=>{item.showOriginal=!item.showOriginal;updateThumb(i);};
 }
 el.statusText.textContent=`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${files.length} ØµÙˆØ±Ø©`;
}

// Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª
['dragenter','dragover','dragleave','drop'].forEach(ev=>{
 el.dropZone.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();});
});
['dragenter','dragover'].forEach(ev=>{
 el.dropZone.addEventListener(ev,()=>el.dropZone.classList.add('dragover'));
});
['dragleave','drop'].forEach(ev=>{
 el.dropZone.addEventListener(ev,()=>el.dropZone.classList.remove('dragover'));
});
el.dropZone.addEventListener('drop',e=>{
 const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
 handleFiles(files);
});
el.dropZone.onclick=()=>el.picker.click();
el.picker.onchange=()=>handleFiles([...el.picker.files]);

// ØªØ­ÙƒÙ… ÙÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ù‚Øµ
[el.topCut,el.bottomCut].forEach(input=>{
 input.addEventListener('input',()=>{
  el.topVal.textContent=el.topCut.value+'%';
  el.bottomVal.textContent=el.bottomCut.value+'%';
  state.items.forEach((_,i)=>processOne(i)); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
 });
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
await waitForCV();
await loadSuperRes();
state.opencvReady=true;
el.statusText.textContent="âœ… Ø¬Ø§Ù‡Ø² Ù„Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© 4K";
})();
</script>
</body>
</html>
