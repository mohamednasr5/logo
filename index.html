<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🛠️ إزالة الشعار المتقدمة بالذكاء الاصطناعي | مهندس محمد حماد</title>
  <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
  <style>
    body { background:#0f1115; color:#e9eef3; font-family:system-ui,Arial; margin:0; }
    h1 { color:#00e0a4; text-align:center; padding:20px 0; }
    main{max-width:1000px;margin:auto;padding:20px;}
    #aiStatus{background:#151923;border:1px solid #2a2f3a;border-radius:8px;padding:12px;text-align:center;margin:16px 0;color:#00e0a4;}
    #dropZone{border:3px dashed #00e0a4;border-radius:16px;padding:60px 20px;text-align:center;cursor:pointer;}
    #dropZone.dragover{background:rgba(0,224,164,0.15);}
    canvas{display:block;margin:20px auto;max-width:100%;height:auto;background:#000;}
    button{background:#00e0a4;color:#02130e;border:none;border-radius:10px;padding:10px 20px;font-weight:700;cursor:pointer;margin:5px;}
    footer{text-align:center;padding:24px;font-size:14px;color:#7a8a9a;border-top:1px solid #2a2f3a;}
    .spin{display:inline-block;animation:spin 1s linear infinite;}
    @keyframes spin{from{transform:rotate(0);}to{transform:rotate(360deg);}}
  </style>
</head>
<body>
  <h1>🛠️ إزالة الشعار المتقدمة بالذكاء الاصطناعي</h1>
  <main>
    <div id="aiStatus">🤖 جارٍ تحميل مكتبة OpenCV...</div>
    <div id="dropZone">📤 اسحب الصور هنا أو اضغط للتحميل</div>
    <canvas id="preview"></canvas>
    <button id="btnProcess">🔄 معالجة الصورة</button>
  </main>
  <footer>
    <p>برمجة وتصميم <strong>المهندس محمد حماد</strong> | <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" style="color:#00e0a4;text-decoration:none;">تابعني على فيسبوك</a></p>
  </footer>

  <script>
    (async () => {
      const el = {
        dropZone: document.getElementById('dropZone'),
        aiStatus: document.getElementById('aiStatus'),
        preview: document.getElementById('preview'),
        btnProcess: document.getElementById('btnProcess')
      };

      const state = { sr: null, image: null };

      // انتظار تحميل OpenCV
      function waitForCV() {
        return new Promise((resolve, reject) => {
          const check = setInterval(() => {
            if (cv && cv.getBuildInformation) {
              clearInterval(check);
              resolve();
            }
          }, 200);
          setTimeout(() => reject("❌ فشل تحميل OpenCV.js"), 10000);
        });
      }

      try {
        await waitForCV();
        el.aiStatus.textContent = "✅ تم تحميل OpenCV.js بنجاح";
      } catch (err) {
        el.aiStatus.textContent = err;
        return;
      }

      // تحميل نموذج ESPCN
      async function loadESPCN() {
        try {
          el.aiStatus.innerHTML = '<span class="spin">🔄</span> جارٍ تحميل نموذج ESPCN_x4.pb...';
          state.sr = new cv.dnn.SuperResolution();
          await state.sr.readModel('https://raw.githubusercontent.com/mohamednasr5/logo/main/ESPCN_x4.pb');
          state.sr.setModel('espcn', 4);
          el.aiStatus.textContent = "✅ تم تحميل نموذج ESPCN_x4 بنجاح - جاهز لتحسين 4K";
        } catch (e) {
          console.error("فشل تحميل ESPCN:", e);
          el.aiStatus.textContent = "⚠️ فشل تحميل نموذج ESPCN_x4 - سيتم استخدام التحسين الافتراضي";
          state.sr = null;
        }
      }

      await loadESPCN();

      // تحميل الصورة
      el.dropZone.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => handleFile(e.target.files[0]);
        input.click();
      });

      el.dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        el.dropZone.classList.add('dragover');
      });

      el.dropZone.addEventListener('dragleave', () => el.dropZone.classList.remove('dragover'));
      el.dropZone.addEventListener('drop', e => {
        e.preventDefault();
        el.dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      });

      async function handleFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            el.preview.width = img.width;
            el.preview.height = img.height;
            const ctx = el.preview.getContext('2d');
            ctx.drawImage(img, 0, 0);
            state.image = img;
            el.aiStatus.textContent = "📷 تم تحميل الصورة - جاهزة للمعالجة";
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      // معالجة الصورة
      el.btnProcess.addEventListener('click', async () => {
        if (!state.image) {
          el.aiStatus.textContent = "⚠️ الرجاء رفع صورة أولاً";
          return;
        }

        el.aiStatus.innerHTML = '<span class="spin">🔄</span> جارٍ معالجة الصورة...';

        try {
          const src = cv.imread(el.preview);
          const dst = new cv.Mat();

          if (state.sr) {
            state.sr.upsample(src, dst);
          } else {
            // fallback تحسين عادي في حالة فشل تحميل النموذج
            cv.resize(src, dst, new cv.Size(src.cols * 2, src.rows * 2), 0, 0, cv.INTER_CUBIC);
          }

          const output = document.createElement('canvas');
          output.width = dst.cols;
          output.height = dst.rows;
          cv.imshow(output, dst);

          el.preview.replaceWith(output);
          el.preview = output;

          src.delete();
          dst.delete();

          el.aiStatus.textContent = "✅ تم تحسين الصورة بنجاح!";
        } catch (error) {
          console.error(error);
          el.aiStatus.textContent = "⚠️ فشل في معالجة الصورة";
        }
      });
    })();
  </script>
</body>
</html>
