<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ | Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
  <style>
    :root {
      --brand: #00e0a4;
      --bg: #0f1115;
      --panel: #151923;
      --text: #e9eef3;
      --border: #2a2f3a;
      --error: #ff4757;
      --success: #00e676;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
    header { padding: 20px; text-align: center; border-bottom: 1px solid var(--border); }
    h1 { color: var(--brand); margin: 0; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin: 16px auto; max-width: 1200px; }
    #dropZone { border: 3px dashed var(--brand); padding: 60px; text-align: center; border-radius: 16px; cursor: pointer; transition: .3s; }
    #dropZone.dragover { background: rgba(0,224,164,.1); }
    progress { width: 100%; height: 20px; border-radius: 10px; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 16px; margin-top: 20px; }
    .thumb-card { background: #0c0f14; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .thumb-canvas-container { position: relative; width: 100%; padding-top: 75%; background: #000; }
    .thumb-canvas-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .thumb-controls { padding: 10px; background: #151923; }
    .thumb-actions { display: flex; gap: 8px; margin-top: 8px; }
    .btn { flex: 1; background: var(--brand); color: #02130e; border: 0; padding: 8px; border-radius: 10px; cursor: pointer; font-weight: bold; }
    .btn-secondary { background: #2a2f3a; color: var(--text); }
    .range-control { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    input[type=range] { flex: 1; height: 6px; }
    .range-value { color: var(--brand); min-width: 40px; text-align: center; font-weight: bold; }
    .stat-card { text-align: center; margin-top: 10px; background: #0c0f14; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .stat-value { font-size: 22px; color: var(--brand); }
  </style>
</head>
<body>
<header>
  <h1>ğŸ› ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ±ÙØ¹ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ± 4K</h1>
  <p>Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ - Ù…Ù† Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</p>
</header>

<main class="card">
  <div id="dropZone">ğŸ“¤ Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§</div>
  <input id="picker" type="file" accept="image/*" multiple style="display:none">
  <progress id="progressBar" value="0" max="100"></progress>
  <p id="statusText">Ø¬Ø§Ù‡Ø²</p>
  <div class="gallery" id="gallery"></div>
  <div id="stats">
    <div class="stat-card"><div class="stat-value" id="statImages">0</div><div>ØµÙˆØ± Ù…Ø±ÙÙˆØ¹Ø©</div></div>
    <div class="stat-card"><div class="stat-value" id="statProcessed">0</div><div>ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§</div></div>
  </div>
</main>

<script>
(async()=>{
'use strict';
const el={dropZone:document.getElementById('dropZone'),
picker:document.getElementById('picker'),
gallery:document.getElementById('gallery'),
progressBar:document.getElementById('progressBar'),
statusText:document.getElementById('statusText'),
statImages:document.getElementById('statImages'),
statProcessed:document.getElementById('statProcessed')};
const state={items:[],opencvReady:false,sr:null};

// ØªØ­Ù…ÙŠÙ„ OpenCV
function waitForCV(){return new Promise((resolve,reject)=>{
 let tries=0;const check=setInterval(()=>{if(cv&&cv.getBuildInformation){clearInterval(check);resolve();}else if(tries++>50){clearInterval(check);reject();}},200);
});}

// ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ESPCN_x4 Ù…Ù† GitHub Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
async function loadSuperRes(){
 state.sr=new cv.dnn.SuperResolution();
 await state.sr.readModel('https://mohamednasr5.github.io/logo/ESPCN_x4.pb');
 state.sr.setModel('espcn',4);
 console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ESPCN_x4 Ø¨Ù†Ø¬Ø§Ø­');
}

// Ø±ÙØ¹ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¥Ù„Ù‰ 4K ÙØ¹Ù„ÙŠÙ‹Ø§
async function upscale4K(canvas){
 return new Promise(resolve=>{
  try{
   const src=cv.imread(canvas);
   const dst=new cv.Mat();
   state.sr.upsample(src,dst);
   const out=document.createElement('canvas');
   out.width=dst.cols;out.height=dst.rows;
   cv.imshow(out,dst);
   src.delete();dst.delete();
   resolve(out);
  }catch(e){console.error(e);resolve(canvas);}
 });
}

// Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø©
function cropImage(img,top,bottom){
 const t=img.height*(top/100),b=img.height*(bottom/100);
 const h=img.height-t-b;
 const canvas=document.createElement('canvas');
 canvas.width=img.width;canvas.height=h;
 const ctx=canvas.getContext('2d');
 ctx.drawImage(img,0,t,img.width,h,0,0,img.width,h);
 return canvas;
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
function updatePreview(idx){
 const item=state.items[idx];if(!item)return;
 const top=parseFloat(item.topCut.value);
 const bottom=parseFloat(item.bottomCut.value);
 const cropped=cropImage(item.img,top,bottom);
 const ctx=item.canvas.getContext('2d');
 ctx.clearRect(0,0,item.canvas.width,item.canvas.height);
 ctx.drawImage(cropped,0,0,item.canvas.width,item.canvas.height);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©
async function processOne(idx){
 const item=state.items[idx];
 const top=parseFloat(item.topCut.value);
 const bottom=parseFloat(item.bottomCut.value);
 const cropped=cropImage(item.img,top,bottom);
 const upscaled=await upscale4K(cropped);
 item.processed=upscaled;
 const ctx=item.canvas.getContext('2d');
 ctx.clearRect(0,0,item.canvas.width,item.canvas.height);
 ctx.drawImage(upscaled,0,0,item.canvas.width,item.canvas.height);
 el.statProcessed.textContent=parseInt(el.statProcessed.textContent)+1;
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±
async function processAll(){
 for(let i=0;i<state.items.length;i++){
  await processOne(i);
  el.progressBar.value=((i+1)/state.items.length)*100;
  el.statusText.textContent=`ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© ${i+1}/${state.items.length}`;
 }
 el.statusText.textContent='âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ù„ÙƒÙ„ ØµÙˆØ±Ø©
function createCard(file,img,idx){
 const card=document.createElement('div');card.className='thumb-card';
 const cont=document.createElement('div');cont.className='thumb-canvas-container';
 const canvas=document.createElement('canvas');cont.appendChild(canvas);
 card.appendChild(cont);
 const controls=document.createElement('div');controls.className='thumb-controls';
 controls.innerHTML=`
 <div class="range-control"><label>Ù‚Øµ Ø¹Ù„ÙˆÙŠ:</label>
 <input type="range" min="0" max="30" step="0.5" value="0" class="topCut">
 <span class="range-value">0%</span></div>
 <div class="range-control"><label>Ù‚Øµ Ø³ÙÙ„ÙŠ:</label>
 <input type="range" min="0" max="30" step="0.5" value="0" class="bottomCut">
 <span class="range-value">0%</span></div>
 <div class="thumb-actions">
 <button class="btn processBtn">ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
 <button class="btn-secondary saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
 </div>`;
 card.appendChild(controls);
 el.gallery.appendChild(card);

 const topCut=controls.querySelector('.topCut');
 const bottomCut=controls.querySelector('.bottomCut');
 const topVal=controls.querySelectorAll('.range-value')[0];
 const bottomVal=controls.querySelectorAll('.range-value')[1];
 const processBtn=controls.querySelector('.processBtn');
 const saveBtn=controls.querySelector('.saveBtn');

 const ctx=canvas.getContext('2d');
 const scale=Math.min(1,280/Math.max(img.width,img.height));
 canvas.width=img.width*scale;canvas.height=img.height*scale;
 ctx.drawImage(img,0,0,canvas.width,canvas.height);

 topCut.oninput=()=>{topVal.textContent=topCut.value+'%';updatePreview(idx);};
 bottomCut.oninput=()=>{bottomVal.textContent=bottomCut.value+'%';updatePreview(idx);};

 processBtn.onclick=()=>processOne(idx);
 saveBtn.onclick=()=>{
  const quality=0.95;
  item.processed.toBlob(b=>{
   const link=document.createElement('a');
   link.href=URL.createObjectURL(b);
   link.download=`mohamed_hammad(${idx+1}).jpg`;
   link.click();
  },'image/jpeg',quality);
 };

 state.items[idx]={img,canvas,topCut,bottomCut,processed:null};
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
async function handleFiles(files){
 el.statusText.textContent='ğŸ“¥ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±...';
 el.progressBar.value=0;
 el.statImages.textContent=files.length;
 for(let i=0;i<files.length;i++){
  const f=files[i];
  const img=new Image();
  img.src=URL.createObjectURL(f);
  await new Promise(r=>img.onload=r);
  createCard(f,img,i);
  el.progressBar.value=((i+1)/files.length)*100;
  await processOne(i); // ØªØ·Ø¨ÙŠÙ‚ 4K ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙˆØ± Ø§Ù„Ø±ÙØ¹
 }
 el.statusText.textContent='âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±';
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
['dragenter','dragover','dragleave','drop'].forEach(ev=>{
 el.dropZone.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();});
});
el.dropZone.addEventListener('drop',e=>{
 const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
 handleFiles(files);
});
el.dropZone.onclick=()=>el.picker.click();
el.picker.onchange=()=>handleFiles([...el.picker.files]);

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
await waitForCV();
await loadSuperRes();
state.opencvReady=true;
el.statusText.textContent='âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
})();
</script>
</body>
</html>
